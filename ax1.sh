#!/bin/bash
# Xrayï¼ˆVlessã€SSï¼‰ã€Hysteria2, UDP2RAW ã€ KCPTUN å®ä¾‹ç®¡ç†è„šæœ¬
# Generated by github.com/halibotee

# --- å…¨å±€å˜é‡é…ç½® ---
SCRIPT_VERSION="1.3.13"

# å®‰è£…ç›®å½•é…ç½®
KCPTUN_INSTALL_DIR="/etc/kcptun"
UDP2RAW_INSTALL_DIR="/etc/udp2raw"
HY2_INSTALL_DIR="/etc/hysteria2"
XRAY_INSTALL_DIR="/etc/xray"

# ACME è¯ä¹¦ç›¸å…³è·¯å¾„
ACME_SH_INSTALL_DIR="/root/.acme.sh/acme.sh"
AX_TOOLS_DIR="/etc/ax-tools"
AX_CERT_DIR="/etc/ax-certs"

# Systemd æœåŠ¡æ¨¡æ¿è·¯å¾„
KCPTUN_TEMPLATE_FILE="/etc/systemd/system/ax-kcptun@.service"
UDP2RAW_TEMPLATE_FILE="/etc/systemd/system/ax-udp2raw@.service"
HY2_TEMPLATE_FILE="/etc/systemd/system/ax-hysteria2@.service"
XRAY_TEMPLATE_FILE="/etc/systemd/system/ax-xray@.service"

# ç½‘ç»œé»˜è®¤é…ç½®
PUBLIC_IP=""  # å…¬ç½‘IPåœ°å€ï¼ˆè‡ªåŠ¨è·å–ï¼‰
DEFAULT_LISTEN_ADDR="0.0.0.0"  # é»˜è®¤ç›‘å¬åœ°å€
DEFAULT_TARGET_ADDR="127.0.0.1"  # é»˜è®¤ç›®æ ‡åœ°å€
RANDOM_PORT_MIN=10000  # éšæœºç«¯å£èŒƒå›´æœ€å°å€¼
RANDOM_PORT_MAX=65535  # éšæœºç«¯å£èŒƒå›´æœ€å¤§å€¼
PUBLIC_IP_SERVICE_1="ip.sb"  # å…¬ç½‘IPæŸ¥è¯¢æœåŠ¡1
PUBLIC_IP_SERVICE_2="ipinfo.io/ip"  # å…¬ç½‘IPæŸ¥è¯¢æœåŠ¡2

# Hysteria2 é»˜è®¤é…ç½®
HY2_SNI="bing.com"  # é»˜è®¤SNIï¼ˆè‡ªç­¾åè¯ä¹¦ä½¿ç”¨ï¼‰
HY2_CERT_PATH="/etc/ssl/private/${HY2_SNI}.crt"  # è‡ªç­¾åè¯ä¹¦è·¯å¾„
HY2_KEY_PATH="/etc/ssl/private/${HY2_SNI}.key"  # è‡ªç­¾åå¯†é’¥è·¯å¾„
HY2_MASQUERADE_URL="https://www.bing.com"  # ä¼ªè£…ç½‘ç«™URL
HY2_CLIENT_INSECURE="1"  # å®¢æˆ·ç«¯ä¸éªŒè¯è¯ä¹¦ï¼ˆè‡ªç­¾åæ—¶ä½¿ç”¨ï¼‰

# Xray VLESS é»˜è®¤é…ç½®
XRAY_REALITY_DEFAULT_SNI="www.apple.com"  # Realityé»˜è®¤SNI
XRAY_REALITY_DEFAULT_FP="chrome"  # RealityæŒ‡çº¹ä¼ªè£…
XRAY_REALITY_DEFAULT_TARGET="www.apple.com:443"  # Realityç›®æ ‡åœ°å€
XRAY_REALITY_DEFAULT_FLOW="xtls-rprx-vision"  # Realityæµæ§æ¨¡å¼
KCPTUN_DEFAULT_MODE="fast3"  # KCPTUNé»˜è®¤æ¨¡å¼
SS_DEFAULT_METHOD="2022-blake3-aes-256-gcm"  # Shadowsocksé»˜è®¤åŠ å¯†æ–¹å¼

# WARP åˆ†æµé…ç½®
DEFAULT_WARP_SOCKS_ADDR="127.0.0.1"  # WARP SOCKS5ä»£ç†åœ°å€
DEFAULT_WARP_SOCKS_PORT="40000"  # WARP SOCKS5ä»£ç†ç«¯å£
WARP_GEOSITE_LIST_JSON='"geosite:google","geosite:openai","geosite:perplexity"'
WARP_GEOSITE_LIST_YAML='- warp(suffix:ip-api.com)
    - warp(geosite:google)
    - warp(geoip:google)
    - warp(suffix:google.com)
    - warp(geosite:openai)
    - warp(suffix:openai.com)
    - warp(suffix:chatgpt.com)
    - warp(geosite:perplexity)
    - warp(suffix:perplexity.com)'

# è½¯ä»¶æºé…ç½®
KCPTUN_REPO="xtaci/kcptun"
UDP2RAW_REPO="wangyu-/udp2raw"
HY2_REPO="apernet/hysteria"
XRAY_REPO="XTLS/Xray-core"
GITHUB_API_URL="https://api.github.com/repos"
GITHUB_URL="https://github.com"

# å®¢æˆ·ç«¯é»˜è®¤ç›‘å¬ç«¯å£ï¼ˆç”¨äºç”Ÿæˆå®¢æˆ·ç«¯é…ç½®ç¤ºä¾‹ï¼‰
CLIENT_KCPTUN_LISTEN_ADDR="127.0.0.1:1091"  # KCPTUNå®¢æˆ·ç«¯ç›‘å¬åœ°å€
CLIENT_UDP2RAW_LISTEN_ADDR="127.0.0.1:1093"  # UDP2RAWå®¢æˆ·ç«¯ç›‘å¬åœ°å€
CLIENT_VLESS_UDP2RAW_LISTEN_ADDR="127.0.0.1:1094"  # VLESS+UDP2RAWå®¢æˆ·ç«¯ç›‘å¬åœ°å€
CLIENT_SS_3_CHAIN_KCP_TARGET="127.0.0.1:1095"  # SSä¸‰å±‚ä¸²è”KCPTUNç›®æ ‡åœ°å€
CLIENT_SS_3_CHAIN_SS_TARGET="127.0.0.1:1096"  # SSä¸‰å±‚ä¸²è”SSç›®æ ‡åœ°å€

UDP2RAW_COMMON_ARGS="--raw-mode faketcp --cipher-mode aes128cbc --auth-mode hmac_sha1 --seq-mode 4 -a --keep-rule --fix-gro"
UDP2RAW_CLIENT_BASE_ARGS="-c ${UDP2RAW_COMMON_ARGS}"

# --- é…ç½®æ–‡ä»¶æ¨¡æ¿ ---

# KCPTUN é…ç½®æ–‡ä»¶æ¨¡æ¿
read -r -d '' KCPTUN_CONFIG_JSON_TEMPLATE <<'EOM'
{
    "listen": "__LISTEN__", "target": "__TARGET__", "key": "__KEY__", "crypt": "__CRYPT__", "mode": "__MODE__", "smuxver": 2, "mtu": __MTU__, "sndwnd": __SNDWND__, "rcvwnd": __RCVWND__, "datashard": __DATASHARD__, "parityshard": __PARITYSHARD__, "dscp": 46, "nocomp": true, "acknodelay": false, "nodelay": 1, "interval": 20, "resend": 2, "nc": 1, "sockbuf": 16777217, "smuxbuf": 16777217, "streambuf": 4194304, "keepalive": 5, "autoexpire": 600, "quiet": false, "tcp": __TCP__
}
EOM

# UDP2RAW é…ç½®æ–‡ä»¶æ¨¡æ¿
read -r -d '' UDP2RAW_CONFIG_TEMPLATE <<'EOM'
-s
-l __LISTEN_ADDR__
-r __TARGET_ADDR__
-k __PASSWORD__
--raw-mode __RAW_MODE__
--cipher-mode __CIPHER_MODE__
--auth-mode __AUTH_MODE__
--seq-mode 4
-a
--keep-rule
--fix-gro
EOM

# Hysteria2 é…ç½®æ–‡ä»¶æ¨¡æ¿
read -r -d '' HYSTERIA2_CONFIG_YAML_TEMPLATE <<'EOM'
listen: __LISTEN__
tls:
  cert: __CERT_PATH__
  key: __KEY_PATH__
auth:
  type: password
  password: __PASSWORD__
masquerade:
  type: proxy
  proxy:
    url: https://www.macbed.com
    rewriteHost: true
    insecure: false
ignoreClientBandwidth: __IGNORE_BW__
sniff:
  enable: true
  timeout: 2s
  rewriteDomain: true
  tcpPorts: 80,443,8000-9000
  __UDP_SNIFF_CONFIG__
__OUTBOUNDS_AND_ACL__
EOM

# Hysteria2 WARP åˆ†æµ ACL
read -r -d '' HYSTERIA2_WARP_OUTBOUND_ACL_BLOCK <<'EOM'
outbounds:
  - name: warp
    type: socks5
    socks5:
      addr: __WARP_SOCKS5_ADDR__
      udp: false
acl:
  inline:
    __WARP_GEOSITE_LIST_YAML__
    - direct(all)
EOM
HYSTERIA2_WARP_OUTBOUND_ACL_BLOCK="${HYSTERIA2_WARP_OUTBOUND_ACL_BLOCK//__WARP_GEOSITE_LIST_YAML__/$WARP_GEOSITE_LIST_YAML}"

# Hysteria2 ç›´è¿ ACL
read -r -d '' HYSTERIA2_DIRECT_ACL_BLOCK <<'EOM'
acl:
  inline:
    - direct(all)
EOM

# Xray VLESS+Reality é…ç½®æ–‡ä»¶æ¨¡æ¿
read -r -d '' XRAY_VLESS_REALITY_TEMPLATE <<'EOM'
{
    "log": { "loglevel": "warning" },
    "inbounds": [
        {
            "listen": null,
            "port": __LISTEN_PORT__,
            "protocol": "vless",
            "settings": {
                "clients": [
                    {
                        "id": "__UUID__",
                        "flow": "__REALITY_FLOW__"
                    }
                ],
                "decryption": "none"
            },
            "streamSettings": {
                "network": "tcp",
                "security": "reality",
                "realitySettings": {
                    "show": false,
                    "fingerprint": "__FINGERPRINT__",
                    "target": "__TARGET__",
                    "xver": 0,
                    "serverNames": [
                        "__SNI__"
                    ],
                    "privateKey": "__PRIVATE_KEY__",
                    "publicKey": "__PUBLIC_KEY__",
                    "minClientVer": "",
                    "maxClientVer": "",
                    "maxTimeDiff": 60000,
                    "shortIds": [
                        "__SHORT_ID__"
                    ]
                },
                "tcpSettings": {
                    "header": {
                        "type": "none"
                    }
                }
            },
            "tag": "inbound-__LISTEN_PORT__",
            "sniffing": {
                "enabled": true,
                "destOverride": [
                    "http",
                    "tls",
                    "quic"
                ]
            }
        }
    ],
    __OUTBOUNDS_AND_ROUTING__
}
EOM

# Xray VLESS+mKCP é…ç½®æ–‡ä»¶æ¨¡æ¿
read -r -d '' XRAY_VLESS_MKCP_TEMPLATE <<'EOM'
{
    "log": { "loglevel": "warning" },
    "inbounds": [{
        "listen": "__LISTEN_ADDR__",
        "port": __LISTEN_PORT__,
        "protocol": "vless",
        "settings": {
            "clients": [{ "id": "__UUID__" }],
            "decryption": "none"
        },
        "streamSettings": {
            "network": "kcp",
            "kcpSettings": {
                "mtu": __MTU__, "tti": __TTI__, "uplinkCapacity": __UPLINK__, "downlinkCapacity": __DOWNLINK__, "congestion": __CONGESTION__, "readBufferSize": __READ_BUF__, "writeBufferSize": __WRITE_BUF__,
                "header": { "type": "__HEADER_TYPE__" },
                "seed": "__MKCP_SEED__"
            }
        },
        "sniffing": { "enabled": true, "destOverride": [ "http", "tls" ] }
    }],
    __OUTBOUNDS_AND_ROUTING__
}
EOM

# Xray Shadowsocks é…ç½®æ–‡ä»¶æ¨¡æ¿
read -r -d '' XRAY_SHADOWSOCKS_TCP_UDP_TEMPLATE <<'EOM'
{
    "log": { "loglevel": "warning" },
    "inbounds": [{
        "listen": "__LISTEN_ADDR__",
        "port": __LISTEN_PORT__,
        "protocol": "shadowsocks",
        "settings": {
            "method": "__SS_METHOD__",
            "password": "__SS_PASSWORD__",
            "network": "tcp,udp"
        },
        "sniffing": { "enabled": true, "destOverride": [ "http", "tls" ] }
    }],
    __OUTBOUNDS_AND_ROUTING__
}
EOM

# Xray WARP åˆ†æµè·¯ç”±é…ç½®
read -r -d '' XRAY_WARP_OUTBOUND_AND_ROUTING_BLOCK <<'EOM'
"outbounds": [
    { "protocol": "freedom", "tag": "direct" },
    { "protocol": "socks", "tag": "warp", "settings": { "servers": [{ "address": "__WARP_SOCKS5_ADDR__", "port": __WARP_SOCKS5_PORT__ }] } },
    { "protocol": "blackhole", "tag": "block" }
],
"routing": {
    "domainStrategy": "IPIfNonMatch",
    "rules": [
        { "type": "field", "outboundTag": "warp", "domain": [ __WARP_GEOSITE_LIST_JSON__ ] },
        { "type": "field", "outboundTag": "warp", "domain": [ "suffix:ip-api.com" ] },
        { "type": "field", "outboundTag": "block", "domain": [ "geosite:category-ads-all" ] }
    ]
}
EOM
XRAY_WARP_OUTBOUND_AND_ROUTING_BLOCK="${XRAY_WARP_OUTBOUND_AND_ROUTING_BLOCK//__WARP_GEOSITE_LIST_JSON__/$WARP_GEOSITE_LIST_JSON}"

# Xray ç›´è¿è·¯ç”±é…ç½®
read -r -d '' XRAY_DIRECT_OUTBOUND_AND_ROUTING_BLOCK <<'EOM'
"outbounds": [
    { "protocol": "freedom", "tag": "direct" },
    { "protocol": "blackhole", "tag": "block" }
],
"routing": { "rules": [ { "type": "field", "outboundTag": "direct", "network": "tcp,udp" } ] }
EOM


# --- è¾…åŠ©å·¥å…·å‡½æ•° ---

# ç»¿è‰²
green(){ echo -e "\033[0;32m$1\033[0m"; }
# çº¢è‰²
red(){ echo -e "\033[0;31m$1\033[0m"; }
# é»„è‰² (æ©™è‰²)
yellow(){ echo -e "\033[0;33m$1\033[0m"; }
# é’è‰²
cyan(){ echo -e "\033[0;36m$1\033[0m"; }
# ç²—ä½“ (é»˜è®¤è‰²)
bold(){ echo -e "\033[1m$1\033[0m"; }
# æ·¡åŒ– (ç°è‰²)
dim(){ echo -e "\033[2m$1\033[0m"; }
# æ—¥å¿—æ ¼å¼
log(){ echo -e "[$(date '+%H:%M:%S')] $(bold "$1")"; }
# æ£€æŸ¥æ˜¯å¦å·²å®‰è£…ä»»ä½•å®ä¾‹
is_installed(){ ls "$KCPTUN_INSTALL_DIR"/*.json >/dev/null 2>&1 || ls "$UDP2RAW_INSTALL_DIR"/*.conf >/dev/null 2>&1 || ls "$HY2_INSTALL_DIR"/*.yaml >/dev/null 2>&1 || ls "$XRAY_INSTALL_DIR"/*.json >/dev/null 2>&1; }

# è·å–å…¬ç½‘ IP åœ°å€
get_public_ip() {
    if [[ -n "$PUBLIC_IP" ]]; then echo "$PUBLIC_IP"; return; fi
    PUBLIC_IP=$(curl -s4m2 $PUBLIC_IP_SERVICE_1 || curl -s4m2 $PUBLIC_IP_SERVICE_2)
    if [[ -z "$PUBLIC_IP" ]]; then yellow "æ— æ³•è‡ªåŠ¨è·å–å…¬ç½‘ IPï¼Œè¯·æ‰‹åŠ¨è¾“å…¥æˆ–æ£€æŸ¥ç½‘ç»œã€‚"; read -p "è¯·è¾“å…¥å…¬ç½‘ IP: " PUBLIC_IP; if [[ -z "$PUBLIC_IP" ]]; then red "é”™è¯¯ï¼šå¿…é¡»æä¾› IPã€‚"; exit 1; fi; fi
    echo "$PUBLIC_IP"
}

# å®‰è£…è„šæœ¬æ‰€éœ€çš„æ ¸å¿ƒä¾èµ–
install_dependencies(){
    local packages_to_install=()
    ! command -v curl &>/dev/null && packages_to_install+=("curl")
    ! command -v wget &>/dev/null && packages_to_install+=("wget")
    ! command -v tar &>/dev/null && packages_to_install+=("tar")
    ! command -v unzip &>/dev/null && packages_to_install+=("unzip")
    ! command -v nano &>/dev/null && packages_to_install+=("nano")
    ! command -v iptables &>/dev/null && packages_to_install+=("iptables")
    ! command -v uuidgen &>/dev/null && packages_to_install+=("uuid-runtime")
    ! command -v openssl &>/dev/null && packages_to_install+=("openssl")
    ! command -v jq &>/dev/null && packages_to_install+=("jq")
    ! command -v socat &>/dev/null && packages_to_install+=("socat" "lsof")

    # ACME DNS æ¨¡å¼ä¾èµ–
    if ! command -v dig &>/dev/null; then
        if command -v apt-get &>/dev/null; then
            packages_to_install+=("dnsutils")
        elif command -v yum &>/dev/null || command -v dnf &>/dev/null; then
            packages_to_install+=("bind-utils")
        fi
    fi

    if [ ${#packages_to_install[@]} -gt 0 ]; then
        log "æ›´æ–°è½¯ä»¶åŒ…åˆ—è¡¨å¹¶å®‰è£…æ ¸å¿ƒä¾èµ–: ${packages_to_install[*]}..."
        (apt-get update && apt-get install -y "${packages_to_install[@]}") >/dev/null 2>&1 || \
        (yum install -y epel-release && yum install -y "${packages_to_install[@]}") >/dev/null 2>&1 || \
        (dnf install -y "${packages_to_install[@]}") >/dev/null 2>&1
    fi
}

# å¸¦é‡è¯•åŠŸèƒ½çš„ä¸‹è½½å‡½æ•°
download_with_retry(){
    local url=$1 output=$2 retries=3 timeout=15
    for ((i=1; i<=retries; i++)); do
        log "ä¸‹è½½ ($i/$retries)ï¼š$url"
        curl -L --connect-timeout 5 --max-time $timeout -o "$output" "$url" && return 0
        yellow "ä¸‹è½½å¤±è´¥ï¼Œæ­£åœ¨é‡è¯•..."
    done
    red "ä¸‹è½½å¤±è´¥è¶…è¿‡ $retries æ¬¡ï¼Œè¯·æ£€æŸ¥ç½‘ç»œã€‚"
    return 1
}

# æŸ¥æ‰¾ä¸€ä¸ªæœªè¢«å ç”¨çš„éšæœºç«¯å£
find_available_port() {
    local port
    while true; do
        port=$(( RANDOM % (RANDOM_PORT_MAX - RANDOM_PORT_MIN + 1) + RANDOM_PORT_MIN ))
        if ! check_port_occupied "$port"; then
            echo "$port"
            return
        fi
    done
}

# é€šç”¨æœåŠ¡éƒ¨ç½²å‡½æ•°
deploy_service_instance() {
    local service_name=$1
    local conf_path=$2
    local config_content=$3
    
    log "æ­£åœ¨å†™å…¥é…ç½®æ–‡ä»¶..."
    echo "$config_content" > "$conf_path"
    
    sync
    log "å¯åŠ¨æœåŠ¡: $service_name ..."
    systemctl enable --now "$service_name"
    sleep 1
    
    if systemctl is-active --quiet "$service_name"; then
        green "æœåŠ¡ $service_name å·²æˆåŠŸå¯åŠ¨ï¼"
        return 0
    else
        red "æœåŠ¡ $service_name å¯åŠ¨å¤±è´¥ï¼è¯·æ£€æŸ¥æ—¥å¿—ã€‚"
        return 1
    fi
}

# æ£€æŸ¥ç«¯å£æ˜¯å¦è¢«å ç”¨
check_port_occupied() {
    local port=$1
    if ss -tuln | grep -q ":${port} "; then
        return 0 # Occupied
    else
        return 1 # Free
    fi
}

# é€šç”¨è¾“å…¥è¯»å–å‡½æ•°
read_input() {
    local prompt="$1"
    local default_value="$2"
    local input_var
    
    if [[ -n "$default_value" ]]; then
        read -p "${prompt} (é»˜è®¤: ${default_value}): " input_var
        echo "${input_var:-$default_value}"
    else
        read -p "${prompt}: " input_var
        echo "$input_var"
    fi
}

# è¯»å–å¸¦é€‰é¡¹çš„è¾“å…¥
# ç”¨æ³•: read_input_with_options "æç¤ºä¿¡æ¯" "é»˜è®¤é€‰é¡¹(æ•°å­—)" "é€‰é¡¹1æè¿°" "é€‰é¡¹2æè¿°" ...
read_input_with_options() {
    local prompt="$1"
    local default_index="$2"
    shift 2
    local options=("$@")
    
    echo "$prompt" >&2
    for i in "${!options[@]}"; do
        echo "  $((i+1)). ${options[$i]}" >&2
    done
    
    local choice
    read -p "è¯·é€‰æ‹© [1-${#options[@]}] (é»˜è®¤: $default_index): " choice
    choice="${choice:-$default_index}"
    
    if [[ ! "$choice" =~ ^[0-9]+$ ]] || (( choice < 1 || choice > ${#options[@]} )); then
        echo "$default_index" # Invalid input, return default
    else
        echo "$choice"
    fi
}

# æ£€æŸ¥å•ä¸ªæœåŠ¡çŠ¶æ€
check_service_status() {
    local service_name=$1
    if systemctl is-active --quiet "$service_name"; then
        echo "è¿è¡Œä¸­"
    else
        echo "æœªè¿è¡Œ"
    fi
}

# æ£€æŸ¥å¤šä¸ªæœåŠ¡çŠ¶æ€ (å…¨éƒ¨è¿è¡Œæ‰ç®—è¿è¡Œä¸­)
check_services_status() {
    local services=("$@")
    local all_active=true
    local status_details=""
    
    for service in "${services[@]}"; do
        local status=$(check_service_status "$service")
        status_details+="${status} "
        if [[ "$status" != "è¿è¡Œä¸­" ]]; then
            all_active=false
        fi
    done
    
    if $all_active; then
        echo "cyan ${status_details}"
    else
        echo "yellow ${status_details}"
    fi
}

# ç”Ÿæˆå¼ºå¯†ç  (UUID)
generate_strong_password() {
    if command -v uuidgen >/dev/null 2>&1; then
        uuidgen
    else
        log "uuidgen æœªæ‰¾åˆ°ï¼Œç”Ÿæˆå¤‡ç”¨ UUID..." >&2
        hexdump -n 16 -v -e '4/4 "%08x" "-" 2/2 "%04x" "-" 2/2 "%04x" "-" 2/2 "%04x" "-" 6/6 "%012x"' /dev/urandom | head -c 36
    fi
}
# ç”Ÿæˆ Hysteria2 è‡ªç­¾åè¯ä¹¦
generate_self_signed_cert() {
    if [[ -s "$HY2_CERT_PATH" && -s "$HY2_KEY_PATH" ]]; then return; fi
    log "æ­£åœ¨ä¸º ${HY2_SNI} ç”Ÿæˆè‡ªç­¾åè¯ä¹¦..."
    mkdir -p "$(dirname "$HY2_KEY_PATH")"
    openssl ecparam -name prime256v1 -genkey -noout -out "$HY2_KEY_PATH"
    chmod 600 "$HY2_KEY_PATH"
    if [[ $? -ne 0 ]]; then red "é”™è¯¯: openssl ecparam å‘½ä»¤æ‰§è¡Œå¤±è´¥ã€‚"; exit 1; fi
    openssl req -new -x509 -days 36500 -key "$HY2_KEY_PATH" -out "$HY2_CERT_PATH" -subj "/CN=${HY2_SNI}" -nodes
    if [[ $? -ne 0 ]]; then red "é”™è¯¯: openssl req å‘½ä»¤æ‰§è¡Œå¤±è´¥ã€‚"; exit 1; fi
    if [[ ! -s "$HY2_CERT_PATH" || ! -s "$HY2_KEY_PATH" ]]; then red "é”™è¯¯: è¯ä¹¦æ–‡ä»¶ç”Ÿæˆå¤±è´¥æˆ–ä¸ºç©ºï¼"; exit 1; fi
    green "è¯ä¹¦ç”Ÿæˆå®Œæ¯•ã€‚"
}

# å¤„ç†å¯†ç è¾“å…¥ (æ”¯æŒè‡ªåŠ¨ç”Ÿæˆå’Œä¿å­˜)
handle_password_input() {
    local service_type=$1
    local ss_method=$2
    local pass_file
    local last_pass=""
    
    case "$service_type" in
        kcptun) mkdir -p "$KCPTUN_INSTALL_DIR"; pass_file="$KCPTUN_INSTALL_DIR/last_kcptun_pass.txt" ;;
        udp2raw) mkdir -p "$UDP2RAW_INSTALL_DIR"; pass_file="$UDP2RAW_INSTALL_DIR/last_udp2raw_pass.txt" ;;
        hysteria2) mkdir -p "$HY2_INSTALL_DIR"; pass_file="$HY2_INSTALL_DIR/last_hy2_pass.txt" ;;
        xray_mkcp) mkdir -p "$XRAY_INSTALL_DIR"; pass_file="$XRAY_INSTALL_DIR/last_xray_mkcp_seed.txt" ;;
        shadowsocks) mkdir -p "$XRAY_INSTALL_DIR"; pass_file="$XRAY_INSTALL_DIR/last_ss_pass.txt" ;;
    esac
    
    if [[ -f "$pass_file" ]]; then last_pass=$(cat "$pass_file"); fi

    local prompt_label="å¯†ç "
    if [[ "$service_type" == "shadowsocks" ]]; then prompt_label="Base64 å¯†é’¥"; fi
    if [[ "$service_type" == "xray_mkcp" ]]; then prompt_label="mKCP Seed"; fi

    # [FIX] ä½¿ç”¨ >&2 ç¡®ä¿ä¸æ±¡æŸ“ stdout
    echo "è¯·é€‰æ‹© ${prompt_label} ç”Ÿæˆæ–¹å¼:" >&2
    local options=("è‡ªåŠ¨ç”Ÿæˆ ${prompt_label}")
    local default_opt="1"
    
    if [[ -n "$last_pass" ]]; then
        options+=("ä¿ç•™åŸæœ‰ ${prompt_label} (å½“å‰: ${last_pass:0:10}...)")
        default_opt="1"
    fi
    options+=("æ‰‹åŠ¨è¾“å…¥ ${prompt_label}")
    
    # read_input_with_options å†…éƒ¨å·²ç»å¤„ç†äº† stderr æ˜¾ç¤ºï¼Œä½†è¿”å›çš„æ˜¯ stdout çš„æ•°å­—
    # æ‰€ä»¥è¿™é‡Œ capture æ˜¯å®‰å…¨çš„
    local choice_idx=$(read_input_with_options "è¯·é€‰æ‹© [1-${#options[@]}]" "$default_opt" "${options[@]}")
    
    local final_password=""
    local is_manual=false
    
    # é€»è¾‘æ˜ å°„
    if [[ -n "$last_pass" ]]; then
        if [[ "$choice_idx" == "1" ]]; then is_manual=false;
        elif [[ "$choice_idx" == "2" ]]; then final_password="$last_pass";
        else is_manual=true; fi
    else
        if [[ "$choice_idx" == "1" ]]; then is_manual=false;
        else is_manual=true; fi
    fi

    if [[ "$is_manual" == "true" ]]; then
        # read -p é»˜è®¤è¾“å‡ºåˆ° stderr (åœ¨ script ä¸­), æ˜¾å¼åŠ  >&2 æ›´ä¿é™©
        read -p "è¯·è¾“å…¥ ${prompt_label}: " final_password
        if [[ -z "$final_password" ]]; then echo -e "[0;31mè¾“å…¥ä¸èƒ½ä¸ºç©ºï¼[0m" >&2; return 1; fi
    elif [[ -z "$final_password" ]]; then
        # è‡ªåŠ¨ç”Ÿæˆ
        if [[ "$service_type" == "shadowsocks" ]]; then
            local key_length=32
            if [[ "$ss_method" == *"aes-128-gcm"* ]]; then key_length=16; fi
            
            if ! command -v openssl &>/dev/null; then
                echo -e "[0;31mé”™è¯¯: æœªæ‰¾åˆ° openssl[0m" >&2
                final_password=$(generate_strong_password)
            else
                final_password=$(openssl rand -base64 $key_length)
            fi
            echo -e "[0;32må·²è‡ªåŠ¨ç”Ÿæˆ Shadowsocks å¯†é’¥: $final_password[0m" >&2
        else
            final_password=$(generate_strong_password)
            echo -e "[0;32må·²è‡ªåŠ¨ç”Ÿæˆéšæœºå¯†ç : $final_password[0m" >&2
        fi
    fi

    echo "$final_password" > "$pass_file"
    chmod 600 "$pass_file"
    
    # [å…³é”®] åªæœ‰è¿™ä¸€è¡Œè¾“å‡ºåˆ° stdout
    echo "$final_password"
}

find_next_available_id() {
    local type=$1; local dir file_prefix file_ext; local i=1
    case "$type" in
        hysteria2) dir="$HY2_INSTALL_DIR"; file_prefix="hy2"; file_ext="yaml";;
        udp2raw) dir="$UDP2RAW_INSTALL_DIR"; file_prefix="udp2raw"; file_ext="conf";;
        kcptun) dir="$KCPTUN_INSTALL_DIR"; file_prefix="kcptun"; file_ext="json";;
        xray) dir="$XRAY_INSTALL_DIR"; file_prefix="xray"; file_ext="json";;
    esac
    while true; do
        if [[ ! -f "$dir/${file_prefix}_${i}.${file_ext}" && ! -f "$dir/${file_prefix}_c${i}.${file_ext}" && ! -f "$dir/${file_prefix}_vc${i}.${file_ext}" && ! -f "$dir/${file_prefix}_s3c${i}.${file_ext}" ]]; then
            echo "$i"; return
        fi
        i=$((i + 1))
    done
}

# --- ACME è¯ä¹¦ç®¡ç†å‡½æ•° ---

# å®‰è£… acme.sh å®¢æˆ·ç«¯
install_acme_sh_client() {
    if [ -f "$ACME_SH_INSTALL_DIR" ]; then
        return 0 # å·²å®‰è£…
    fi
    log "æ­£åœ¨å®‰è£… acme.sh è¯ä¹¦å®¢æˆ·ç«¯..."
    
    local Aemail=$(read_input "è¯·è¾“å…¥æ³¨å†Œ ACME æ‰€éœ€çš„é‚®ç®± (å›è½¦è‡ªåŠ¨ç”Ÿæˆ)" "")
    if [ -z "$Aemail" ]; then
        local auto_email=$(date +%s%N | md5sum | cut -c 1-8)
        Aemail="$auto_email@gmail.com"
        yellow "å·²ä¸ºæ‚¨è‡ªåŠ¨ç”Ÿæˆé‚®ç®±: $Aemail"
    fi

    # ä½¿ç”¨ get.acme.sh å®˜æ–¹å®‰è£…
    curl https://get.acme.sh | sh -s email=$Aemail
    if [ ! -f "$ACME_SH_INSTALL_DIR" ]; then
        red "acme.sh å®¢æˆ·ç«¯å®‰è£…å¤±è´¥ï¼"
        return 1
    fi
    
    "$ACME_SH_INSTALL_DIR" --upgrade --auto-upgrade
    "$ACME_SH_INSTALL_DIR" --set-default-ca --server letsencrypt
    green "acme.sh å®¢æˆ·ç«¯å®‰è£…å®Œæˆã€‚"
}

# æ£€æŸ¥å¹¶é‡Šæ”¾ 80 ç«¯å£ (ç”¨äº ACME Standalone æ¨¡å¼)
release_80_port() {
    log "æ­£åœ¨æ£€æŸ¥ 80 ç«¯å£å ç”¨..."
    local pid=$(lsof -t -i:80)
    if [ -n "$pid" ]; then
        yellow "è­¦å‘Š: 80 ç«¯å£è¢«è¿›ç¨‹ $pid å ç”¨ã€‚"
        read -p "æ˜¯å¦å°è¯•å¼ºè¡Œé‡Šæ”¾ 80 ç«¯å£? (é»˜è®¤â€œå¦â€) [Y/n]: " kill_confirm
        kill_confirm=${kill_confirm:-n}
        if [[ "$kill_confirm" == "y" || "$kill_confirm" == "Y" ]]; then
            log "æ­£åœ¨å¼ºè¡Œé‡Šæ”¾ 80 ç«¯å£..."
            kill -9 $pid
            sleep 2
            if lsof -t -i:80 >/dev/null; then
                red "80 ç«¯å£é‡Šæ”¾å¤±è´¥ï¼"
                return 1
            else
                green "80 ç«¯å£å·²é‡Šæ”¾ã€‚"
            fi
        else
            red "80 ç«¯å£è¢«å ç”¨ï¼ŒACME Standalone æ¨¡å¼æ— æ³•ç»§ç»­ã€‚"
            return 1
        fi
    fi
    return 0
}

# è·å–æˆ–ç»­è®¢è¯ä¹¦ (æ”¯æŒ DNS API å’Œ Standalone)
ax_get_certificate() {
    local domain=$1
    local cert_dir="$AX_CERT_DIR/$domain"
    
    # 1. æ£€æŸ¥è¯ä¹¦æ˜¯å¦å·²å­˜åœ¨ä¸”æœ‰æ•ˆ
    if [ -f "$cert_dir/fullchain.cer" ]; then
        log "è¯ä¹¦ $domain å·²å­˜åœ¨äº $cert_dir"
        return 0
    fi
    
    # 2. ç¡®ä¿ acme.sh å®¢æˆ·ç«¯å·²å®‰è£…
    install_acme_sh_client || return 1
    
    # 3. æ£€æŸ¥ DNS è§£æ
    log "æ­£åœ¨éªŒè¯ $domain çš„ DNS è§£æ..."
    local v4=$(curl -s4m2 $PUBLIC_IP_SERVICE_1 || curl -s4m2 $PUBLIC_IP_SERVICE_2)
    local v6=$(curl -s6m2 $PUBLIC_IP_SERVICE_1 || curl -s6m2 $PUBLIC_IP_SERVICE_2)
    local domainIP=$(dig @8.8.8.8 +time=2 +short "$domain" 2>/dev/null | grep -m1 '^[0-9]\+\.[0-9]\+\.[0-9]\+\.[0-9]\+$')
    
    if [[ -z "$domainIP" && -n "$v6" ]]; then
        domainIP=$(dig @2001:4860:4860::8888 +time=2 aaaa +short "$domain" 2>/dev/null | grep -m1 ':')
    fi
    
    if [[ -z "$domainIP" ]]; then
        red "é”™è¯¯: æ— æ³•è§£æ $domain çš„ IP åœ°å€ã€‚"
        return 1
    fi
    
    if [[ "$domainIP" != "$v4" && "$domainIP" != "$v6" ]]; then
        red "é”™è¯¯: $domain è§£æçš„ IP ($domainIP) ä¸æœ¬æœº IP ($v4 / $v6) ä¸åŒ¹é…ï¼"
        yellow "è¯·ç¡®ä¿ DNS è®°å½•å·²æ­£ç¡®è®¾ç½®ï¼Œä¸” CDN (å°é»„äº‘) å·²å…³é—­ã€‚"
        return 1
    fi
    green "DNS éªŒè¯é€šè¿‡: $domain -> $domainIP"

    # 4. é€‰æ‹© ACME æ¨¡å¼
    read -p "é€‰æ‹© ACME éªŒè¯æ¨¡å¼: [1] 80 ç«¯å£ (Standalone) [2] DNS API (æ¨è): " acme_mode
    local issue_cmd=""

    if [ "$acme_mode" == "1" ]; then
        # 80 ç«¯å£æ¨¡å¼
        release_80_port || return 1
        local listen_opt=""
        if [[ "$domainIP" == "$v6" ]]; then
            listen_opt="--listen-v6"
        fi
        issue_cmd="$ACME_SH_INSTALL_DIR --issue -d $domain --standalone -k ec-256 $listen_opt"
    
    elif [ "$acme_mode" == "2" ]; then
        # DNS API æ¨¡å¼
        read -p "é€‰æ‹© DNS æœåŠ¡å•†: [1] Cloudflare [2] DNSPod [3] Aliyun: " dns_provider
        local dns_api_cmd=""
        yellow "è­¦å‘Š: API å¯†é’¥å°†ä¿å­˜åœ¨ acme.sh é…ç½®ä¸­ (~/.acme.sh/account.conf)"
        
        case $dns_provider in
            1) # Cloudflare
                read -s -p "è¯·è¾“å…¥ Cloudflare Global API Key: " GAK; echo
                export CF_Key="$GAK"
                read -p "è¯·è¾“å…¥ Cloudflare æ³¨å†Œé‚®ç®±: " CFemail
                export CF_Email="$CFemail"
                dns_api_cmd="--dns dns_cf"
                ;;
            2) # DNSPod
                read -s -p "è¯·è¾“å…¥ DNSPod DP_Id: " DPID; echo
                export DP_Id="$DPID"
                read -s -p "è¯·è¾“å…¥ DNSPod DP_Key: " DPKEY; echo
                export DP_Key="$DPKEY"
                dns_api_cmd="--dns dns_dp"
                ;;
            3) # Aliyun
                read -s -p "è¯·è¾“å…¥ Aliyun Ali_Key: " ALKEY; echo
                export Ali_Key="$ALKEY"
                read -s -p "è¯·è¾“å…¥ Aliyun Ali_Secret: " ALSER; echo
                export Ali_Secret="$ALSER"
                dns_api_cmd="--dns dns_ali"
                ;;
            *)
                red "æ— æ•ˆçš„æœåŠ¡å•†é€‰æ‹©ã€‚"
                return 1
                ;;
        esac
        issue_cmd="$ACME_SH_INSTALL_DIR --issue -d $domain $dns_api_cmd -k ec-256"
    
    else
        red "æ— æ•ˆçš„æ¨¡å¼é€‰æ‹©ã€‚"
        return 1
    fi

    # 5. æ‰§è¡Œç”³è¯·
    log "æ­£åœ¨æ‰§è¡Œ ACME è¯ä¹¦ç”³è¯·ï¼Œè¯·ç¨å€™..."
    eval $issue_cmd
    if [ $? -ne 0 ]; then
        red "ACME è¯ä¹¦ç”³è¯·å¤±è´¥ï¼"
        return 1
    fi
    
    # 6. å®‰è£…è¯ä¹¦åˆ° ax ç›®å½•
    log "æ­£åœ¨å®‰è£…è¯ä¹¦åˆ° $cert_dir ..."
    mkdir -p "$cert_dir"
    "$ACME_SH_INSTALL_DIR" --install-cert -d "$domain" --ecc \
        --fullchain-file "$cert_dir/fullchain.cer" \
        --key-file "$cert_dir/private.key"
        
    if [ -f "$cert_dir/fullchain.cer" ]; then
        green "è¯ä¹¦ $domain å·²æˆåŠŸå®‰è£…åˆ° $cert_dir"
        # ç¡®ä¿ cron ä»»åŠ¡å·²è®¾ç½®
        "$ACME_SH_INSTALL_DIR" --cron -f >/dev/null 2>&1
        return 0
    else
        red "è¯ä¹¦å®‰è£…å¤±è´¥ï¼"
        return 1
    fi
}


# --- æ ¸å¿ƒç¨‹åºä¸‹è½½å‡½æ•° ---

get_latest_github_tag() {
    local repo_name=$1
    # ä½¿ç”¨ jq è·å–æœ€æ–° tag
    curl -s "$GITHUB_API_URL/$repo_name/releases/latest" | jq -r .tag_name
}

# ä¸‹è½½ KCPTUN å’Œ UDP2RAW
download_kcp_udp_binaries(){
    KCPTUN_LATEST=$(get_latest_github_tag "$KCPTUN_REPO")
    UDP2RAW_LATEST=$(get_latest_github_tag "$UDP2RAW_REPO")
    if [[ -z "$KCPTUN_LATEST" || -z "$UDP2RAW_LATEST" ]]; then red "è·å– KCPTUN/UDP2RAW ç‰ˆæœ¬å·å¤±è´¥ã€‚"; return 1; fi
    mkdir -p "$KCPTUN_INSTALL_DIR" "$UDP2RAW_INSTALL_DIR"
    
    log "ä¸‹è½½ KCPTUN ($KCPTUN_LATEST)..."
    download_with_retry "$GITHUB_URL/$KCPTUN_REPO/releases/download/${KCPTUN_LATEST}/kcptun-linux-amd64-$(echo $KCPTUN_LATEST | sed 's/v//').tar.gz" /tmp/kcptun.tar.gz && \
    tar -xzf /tmp/kcptun.tar.gz -C "$KCPTUN_INSTALL_DIR" server_linux_amd64 && mv "$KCPTUN_INSTALL_DIR/server_linux_amd64" "$KCPTUN_INSTALL_DIR/kcptun_server" || { red "KCPTUN è§£å‹æˆ–ç§»åŠ¨å¤±è´¥ã€‚"; return 1; }
    
    log "ä¸‹è½½ UDP2RAW ($UDP2RAW_LATEST)..."
    download_with_retry "$GITHUB_URL/$UDP2RAW_REPO/releases/download/${UDP2RAW_LATEST}/udp2raw_binaries.tar.gz" /tmp/udp2raw.tar.gz && \
    tar -xzf /tmp/udp2raw.tar.gz -C "$UDP2RAW_INSTALL_DIR" udp2raw_amd64 && mv "$UDP2RAW_INSTALL_DIR/udp2raw_amd64" "$UDP2RAW_INSTALL_DIR/udp2raw" || { red "UDP2RAW è§£å‹æˆ–ç§»åŠ¨å¤±è´¥ã€‚"; return 1; }
    
    chmod +x "$KCPTUN_INSTALL_DIR/kcptun_server" "$UDP2RAW_INSTALL_DIR/udp2raw"
}

# ä¸‹è½½ Hysteria2
download_hysteria2_binary(){
    HY2_LATEST=$(get_latest_github_tag "$HY2_REPO")
    if [[ -z "$HY2_LATEST" ]]; then red "è·å– Hysteria2 ç‰ˆæœ¬å·å¤±è´¥ã€‚"; return 1; fi
    mkdir -p "$HY2_INSTALL_DIR"
    log "ä¸‹è½½ Hysteria2 ($HY2_LATEST)..."
    local hy2_url="$GITHUB_URL/$HY2_REPO/releases/download/${HY2_LATEST}/hysteria-linux-amd64"
    download_with_retry "$hy2_url" "$HY2_INSTALL_DIR/hysteria" || { red "Hysteria2 ä¸‹è½½å¤±è´¥ã€‚"; return 1; }
    chmod +x "$HY2_INSTALL_DIR/hysteria"
}

# ä¸‹è½½ Xray-core
download_xray_binary(){
    XRAY_LATEST=$(get_latest_github_tag "$XRAY_REPO")
    if [[ -z "$XRAY_LATEST" ]]; then red "è·å– Xray-core ç‰ˆæœ¬å·å¤±è´¥ã€‚"; return 1; fi
    mkdir -p "$XRAY_INSTALL_DIR"
    log "ä¸‹è½½ Xray-core ($XRAY_LATEST)..."
    local xray_url="$GITHUB_URL/$XRAY_REPO/releases/download/${XRAY_LATEST}/Xray-linux-64.zip"
    download_with_retry "$xray_url" /tmp/xray.zip || { red "Xray-core ä¸‹è½½å¤±è´¥ã€‚"; return 1; }
    unzip -o /tmp/xray.zip -d "$XRAY_INSTALL_DIR" xray geoip.dat geosite.dat || { red "Xray-core è§£å‹å¤±è´¥ã€‚"; return 1; }
    chmod +x "$XRAY_INSTALL_DIR/xray"
    
    # å¤åˆ¶ geo dat æ–‡ä»¶åˆ° Hysteria2 æ ¹ç›®å½•
    log "æ­£åœ¨å¤åˆ¶ geoip.dat / geosite.dat åˆ° Hysteria2 ç›®å½•..."
    cp -n "$XRAY_INSTALL_DIR/geoip.dat" "$HY2_INSTALL_DIR/" 2>/dev/null
    cp -n "$XRAY_INSTALL_DIR/geosite.dat" "$HY2_INSTALL_DIR/" 2>/dev/null
    chmod 644 "$HY2_INSTALL_DIR/geoip.dat" "$HY2_INSTALL_DIR/geosite.dat" 2>/dev/null
}

# --- Systemd ä¸æœåŠ¡çŠ¶æ€ç®¡ç† ---

# ç¡®ä¿æ‰€æœ‰ Systemd æ¨¡æ¿æ–‡ä»¶éƒ½å­˜åœ¨
ensure_template_files() {
    local changed=0
    if [[ ! -f "$KCPTUN_TEMPLATE_FILE" ]]; then
        changed=1
        cat > "$KCPTUN_TEMPLATE_FILE" <<E_O_F
[Unit]
Description=KCPTUN Instance Server (Instance %i)
After=network.target
[Service]
Type=simple
ExecStart=$KCPTUN_INSTALL_DIR/kcptun_server -c $KCPTUN_INSTALL_DIR/kcptun_%i.json
Restart=always
RestartSec=3
[Install]
WantedBy=multi-user.target
E_O_F
    fi
    if [[ ! -f "$UDP2RAW_TEMPLATE_FILE" ]]; then
        changed=1
        cat > "$UDP2RAW_TEMPLATE_FILE" <<E_O_F
[Unit]
Description=UDP2RAW Instance Server (Instance %i)
After=network.target
[Service]
Type=simple
ExecStart=$UDP2RAW_INSTALL_DIR/udp2raw --conf-file $UDP2RAW_INSTALL_DIR/udp2raw_%i.conf
Restart=always
RestartSec=3
[Install]
WantedBy=multi-user.target
E_O_F
    fi
    if [[ ! -f "$HY2_TEMPLATE_FILE" ]]; then
        changed=1
        generate_self_signed_cert
        cat > "$HY2_TEMPLATE_FILE" <<E_O_F
[Unit]
Description=Hysteria2 Service (Instance %i)
After=network.target
[Service]
Type=simple
ExecStart=$HY2_INSTALL_DIR/hysteria -c $HY2_INSTALL_DIR/hy2_%i.yaml server
AmbientCapabilities=CAP_NET_ADMIN CAP_NET_BIND_SERVICE CAP_NET_RAW
CapabilityBoundingSet=CAP_NET_ADMIN CAP_NET_BIND_SERVICE CAP_NET_RAW
Restart=always
RestartSec=3
[Install]
WantedBy=multi-user.target
E_O_F
    fi
    if [[ ! -f "$XRAY_TEMPLATE_FILE" ]]; then
        changed=1
        cat > "$XRAY_TEMPLATE_FILE" <<E_O_F
[Unit]
Description=Xray Service (Instance %i)
After=network.target
[Service]
Type=simple
ExecStart=$XRAY_INSTALL_DIR/xray -c $XRAY_INSTALL_DIR/xray_%i.json
AmbientCapabilities=CAP_NET_ADMIN CAP_NET_BIND_SERVICE CAP_NET_RAW
CapabilityBoundingSet=CAP_NET_ADMIN CAP_NET_BIND_SERVICE CAP_NET_RAW
Restart=always
RestartSec=3
[Install]
WantedBy=multi-user.target
E_O_F
    fi
    if [[ $changed -eq 1 ]]; then systemctl daemon-reload; fi
}

# ä»é…ç½®æ–‡ä»¶æå–ç›‘å¬ä¿¡æ¯
get_listen_info_from_conf() {
    local conf_path=$1
    if [[ ! -f "$conf_path" ]]; then echo "é…ç½®æ–‡ä»¶ä¸å­˜åœ¨"; return; fi

    if [[ "$conf_path" == *".json" ]]; then
        if grep -q '"smuxver"' "$conf_path" 2>/dev/null; then
            grep -Po '(?<="listen": ")[^"]+' "$conf_path"
        else
            local listen=$(jq -r '.inbounds[0].listen // "0.0.0.0"' "$conf_path" 2>/dev/null)
            local port=$(jq -r '.inbounds[0].port // 0' "$conf_path" 2>/dev/null)
            if [[ "$listen" == "null" || "$port" == "0" ]]; then echo "JSONè§£æé”™è¯¯"; else echo "${listen}:${port}"; fi
        fi
    elif [[ "$conf_path" == *".conf" ]]; then
        grep -Po '(?<=-l )[^ ]+' "$conf_path"
    elif [[ "$conf_path" == *".yaml" ]]; then
        local raw_listen=$(grep -Po '(?<=listen: ).*' "$conf_path" | tr -d '[:space:]')
        if [[ "$raw_listen" == :* ]]; then echo "0.0.0.0$raw_listen"; else echo "$raw_listen"; fi
    fi
}

# æ£€æŸ¥ WARP çŠ¶æ€
get_warp_status_from_conf() {
    local conf_path=$1
    if [[ "$conf_path" == *".yaml" ]]; then
        if grep -q "name: warp" "$conf_path" 2>/dev/null; then echo "å·²å¯ç”¨WARP"; else echo "æœªå¯ç”¨WARP"; fi
    elif [[ "$conf_path" == *".json" ]]; then
        if jq -e '.outbounds[] | select(.tag == "warp")' "$conf_path" >/dev/null 2>&1; then echo "å·²å¯ç”¨WARP"; else echo "æœªå¯ç”¨WARP"; fi
    else
        echo ""
    fi
}

# æ˜¾ç¤ºå®ä¾‹çŠ¶æ€è¡Œ
display_instance_status_line() {
    local type=$1 id=$2 prefix=$3; local full_id="$id"; local line
    case "$type" in
        "hy2_chain")
            full_id="c${id}"
            read -r color hy2_status udp_status <<< "$(check_services_status "ax-hysteria2@${full_id}.service" "ax-udp2raw@${full_id}.service")"
            local udp_info=$(get_listen_info_from_conf "$UDP2RAW_INSTALL_DIR/udp2raw_${full_id}.conf")
            local warp_status=$(get_warp_status_from_conf "$HY2_INSTALL_DIR/hy2_${full_id}.yaml")
            line="$($color "${prefix}Hysteria2 [${hy2_status}] + UDP2RAW [${udp_status}] ${udp_info} (${warp_status})")"
            ;;
        "vless_chain")
            full_id="vc${id}"
            read -r color vless_status udp_status <<< "$(check_services_status "ax-xray@${full_id}.service" "ax-udp2raw@${full_id}.service")"
            local udp_info=$(get_listen_info_from_conf "$UDP2RAW_INSTALL_DIR/udp2raw_${full_id}.conf")
            local warp_status=$(get_warp_status_from_conf "$XRAY_INSTALL_DIR/xray_${full_id}.json")
            line="$($color "${prefix}VLESS_mKCP [${vless_status}] + UDP2RAW [${udp_status}] ${udp_info} (${warp_status})")"
            ;;
        "ss_3_chain_chain")
            full_id="s3c${id}"
            read -r color ss_status kcp_status udp_status <<< "$(check_services_status "ax-xray@${full_id}.service" "ax-kcptun@${full_id}.service" "ax-udp2raw@${full_id}.service")"
            local udp_info=$(get_listen_info_from_conf "$UDP2RAW_INSTALL_DIR/udp2raw_${full_id}.conf")
            local warp_status=$(get_warp_status_from_conf "$XRAY_INSTALL_DIR/xray_${full_id}.json")
            line="$($color "${prefix}SS [${ss_status}] + KCP [${kcp_status}] + UDP2RAW [${udp_status}] ${udp_info} (${warp_status})")"
            ;;
        "hysteria2"|"udp2raw"|"kcptun"|"xray_reality"|"xray_mkcp"|"xray_ss")
            local conf_file service_prefix title; local color_func="yellow"
            case "$type" in
                hysteria2) conf_file="$HY2_INSTALL_DIR/hy2_${id}.yaml"; service_prefix="ax-hysteria2"; title="Hysteria2";;
                udp2raw) conf_file="$UDP2RAW_INSTALL_DIR/udp2raw_${id}.conf"; service_prefix="ax-udp2raw"; title="UDP2RAW";;
                kcptun) conf_file="$KCPTUN_INSTALL_DIR/kcptun_${id}.json"; service_prefix="ax-kcptun"; title="KCPTUN";;
                xray_reality) conf_file="$XRAY_INSTALL_DIR/xray_${id}.json"; service_prefix="ax-xray"; title="VLESS+Reality";;
                xray_mkcp) conf_file="$XRAY_INSTALL_DIR/xray_${id}.json"; service_prefix="ax-xray"; title="VLESS+mKCP";;
                xray_ss) conf_file="$XRAY_INSTALL_DIR/xray_${id}.json"; service_prefix="ax-xray"; title="Shadowsocks";;
            esac
            local status_info=$(get_listen_info_from_conf "$conf_file")
            local status_str=$(check_service_status "${service_prefix}@${id}.service")
            local extra_info=""
            if [[ "$type" == "hysteria2" || "$type" == "xray_reality" || "$type" == "xray_mkcp" || "$type" == "xray_ss" ]]; then
                extra_info=" ($(get_warp_status_from_conf "$conf_file"))"
            fi
            if [[ "$status_str" == "è¿è¡Œä¸­" ]]; then color_func="cyan"; fi
            line="$($color_func "${prefix}${title} [${status_str}] ${status_info}${extra_info}")"
            ;;
    esac
    echo -e "$line"
}


# å†…éƒ¨å‡½æ•°ï¼šè·å–æŒ‡å®šç›®å½•ä¸‹çš„æ‰€æœ‰å®ä¾‹ ID
get_instances() {
    local dir=$1 pattern=$2
    ls -1 "$dir"/$pattern 2>/dev/null | sed -E "s/.*_([a-zA-Z0-9]+)\\..*/\1/" | sort -V
}

# è·å– *ç‹¬ç«‹* å®ä¾‹çš„ ID åˆ—è¡¨ (è¿‡æ»¤æ‰ä¸²è”å®ä¾‹)
get_standalone_instances() {
    local type_lowercase=$1
    local dir="" pattern=""
    local standalone_instances=()
    
    case "$type_lowercase" in
        "hysteria2") dir="$HY2_INSTALL_DIR"; pattern="hy2_*.yaml";;
        "xray_reality") dir="$XRAY_INSTALL_DIR"; pattern="xray_*.json";;
        "xray_mkcp") dir="$XRAY_INSTALL_DIR"; pattern="xray_*.json";;
        "xray_ss") dir="$XRAY_INSTALL_DIR"; pattern="xray_*.json";;
        "udp2raw") dir="$UDP2RAW_INSTALL_DIR"; pattern="udp2raw_*.conf";;
        "kcptun") dir="$KCPTUN_INSTALL_DIR"; pattern="kcptun_*.json";;
    esac

    local all_instances=$(get_instances "$dir" "$pattern")
    for i in $all_instances; do
        if [[ "$type_lowercase" == "xray_reality" ]]; then
            grep -q '"security": "reality"' "$dir/xray_${i}.json" 2>/dev/null && standalone_instances+=($i)
        elif [[ "$type_lowercase" == "xray_mkcp" ]]; then
            grep -q '"network": "kcp"' "$dir/xray_${i}.json" 2>/dev/null && [[ ! "$i" =~ ^(vc|s3c)[0-9]+$ ]] && standalone_instances+=($i)
        elif [[ "$type_lowercase" == "xray_ss" ]]; then
            grep -q '"protocol": "shadowsocks"' "$dir/xray_${i}.json" 2>/dev/null && [[ ! "$i" =~ ^s3c[0-9]+$ ]] && standalone_instances+=($i)
        elif [[ ! "$i" =~ ^(c|vc|s3c)[0-9]+$ ]]; then
            standalone_instances+=($i)
        fi
    done
    echo "${standalone_instances[@]}"
}


# --- 13. (ç‹¬ç«‹) å®ä¾‹ç®¡ç†èœå•ä¸æ“ä½œ ---

# ç®¡ç†å•ä¸ªç‹¬ç«‹å®ä¾‹çš„å­èœå•
manage_instance_menu() {
    local type=$1 id=$2 service=$3 conf=$4
    while true; do
        clear; echo "=================================="; echo "      ç®¡ç† ${type^^} å®ä¾‹ $(dim "$id")"; echo "=================================="
        echo "çŠ¶æ€ï¼š$(check_service_status "$service") $(dim "$(get_listen_info_from_conf "$conf")")"
        if [[ "$type" == "hysteria2" ]]; then cyan "è®¢é˜…é“¾æ¥: $(generate_hy2_subscription_link $id)"; fi
        if [[ "$type" == "xray_reality" ]]; then cyan "åˆ†äº«é“¾æ¥: $(generate_xray_reality_link $id)"; fi
        if [[ "$type" == "xray_mkcp" ]]; then cyan "åˆ†äº«é“¾æ¥: $(generate_xray_mkcp_link $id)"; fi
        if [[ "$type" == "xray_ss" ]]; then cyan "åˆ†äº«é“¾æ¥: $(generate_xray_ss_link $id)"; fi
        echo "----------------------------------"; echo "1) å¯åŠ¨/é‡å¯"; echo "2) åœæ­¢"; echo "3) æŸ¥çœ‹å®æ—¶æ—¥å¿—"; echo "4) ç¼–è¾‘é…ç½®"; echo "6) æŸ¥çœ‹å®¢æˆ·ç«¯é…ç½®"; echo "99) åˆ é™¤æ­¤å®ä¾‹"; echo "0) è¿”å›"
        read -p "è¯·é€‰æ‹© [0-6]: " choice
        case $choice in
            1) log "æ­£åœ¨å¯åŠ¨/é‡å¯..."; systemctl restart "$service"; green "æ“ä½œå®Œæˆï¼";;
            2) log "æ­£åœ¨åœæ­¢..."; systemctl stop "$service"; green "æ“ä½œå®Œæˆï¼";;
            3) 
                # ä¿®å¤ Ctrl+C é—®é¢˜
                log "æ­£åœ¨å®æ—¶è·Ÿè¸ªæ—¥å¿—... (æŒ‰ Ctrl+C ä»…é€€å‡ºæ—¥å¿—)"
                sleep 1
                local current_trap=$(trap -p SIGINT) # ä¿å­˜å½“å‰ trap
                trap ':' SIGINT
                journalctl -u "$service" -f --since "1 hour ago"
                eval "$current_trap" # æ¢å¤ trap
                ;;
            4) nano "$conf"; log "é‡å¯å®ä¾‹ä»¥åº”ç”¨é…ç½®..."; systemctl restart "$service"; green "é…ç½®å·²æ›´æ–°ï¼";;
            99) read -p "ç¡®è®¤å½»åº•åˆ é™¤å®ä¾‹ ${id}ï¼Ÿ(é»˜è®¤â€œå¦â€) [y/N]: " confirm; if [[ "$confirm" == "y" || "$confirm" == "Y" ]]; then log "åœæ­¢å¹¶åˆ é™¤..."; systemctl stop "$service"; systemctl disable "$service" >/dev/null 2>&1; rm -f "$conf"; systemctl daemon-reload; green "å®ä¾‹ ${id} å·²åˆ é™¤ï¼"; break; fi;;
            6) clear; echo "--- ${type^^} å®¢æˆ·ç«¯é…ç½® (å®ä¾‹ $id) ---"
               case "$type" in
                   "hysteria2") cyan "è®¢é˜…é“¾æ¥: $(generate_hy2_subscription_link "$id")" ;;
                   "udp2raw") view_udp2raw_client_config "$id" ;;
                   "kcptun") view_kcptun_client_config "$id" ;;
                   "xray_reality") cyan "åˆ†äº«é“¾æ¥: $(generate_xray_reality_link "$id")" ;;
                   "xray_mkcp") cyan "åˆ†äº«é“¾æ¥: $(generate_xray_mkcp_link "$id")" ;;
                   "xray_ss") cyan "åˆ†äº«é“¾æ¥: $(generate_xray_ss_link "$id")" ;;
               esac
               read -p $'\næŒ‰ä»»æ„é”®è¿”å›...' -n1 -s;;
            0) break;; *) red "æ— æ•ˆè¾“å…¥";;
        esac
        [[ "$choice" == "1" || "$choice" == "2" || "$choice" == "4" ]] && read -p $'\næŒ‰ä»»æ„é”®è¿”å›...' -n1 -s
    done
}


# --- JQ å®‰å…¨è¾…åŠ©å‡½æ•° ---
escape_json_val() {
    local val="$1"
    if command -v jq >/dev/null; then
        echo -n "$val" | jq -R -s '.' | sed 's/^"//;s/"$//'
    else
        echo -n "$val"
    fi
}
# åˆ›å»ºä¸€ä¸ªæ–°çš„ç‹¬ç«‹å®ä¾‹ (hy2, udp2raw, kcptun)
create_new_instance() {
    local type=$1; local next_id; local INSTALL_DIR SERVICE_PREFIX FILE_EXT TITLE CONFIG_TEMPLATE SYSTEMD_SERVICE_NAME
    declare -A replacements

    case "$type" in
        hysteria2) 
            TITLE="Hysteria2"
            INSTALL_DIR="$HY2_INSTALL_DIR"
            SERVICE_PREFIX="hy2"
            SYSTEMD_SERVICE_NAME="ax-hysteria2"
            FILE_EXT="yaml"
            CONFIG_TEMPLATE="$HYSTERIA2_CONFIG_YAML_TEMPLATE"

            # --- ACME ä¸ä¼ªè£…é€»è¾‘ ---
            local use_acme=$(read_input "æ˜¯å¦ä½¿ç”¨ ACME (Let's Encrypt) è¯ä¹¦? (å¦åˆ™å°†ä½¿ç”¨è‡ªç­¾åè¯ä¹¦) [Y/n]" "y")
            
            local cert_path="" key_path="" sni="" masquerade_url=""
            
            if [[ "$use_acme" == "y" || "$use_acme" == "Y" ]]; then
                local domain_name=$(read_input "è¯·è¾“å…¥æ‚¨çš„åŸŸå (DNS å¿…é¡»æŒ‡å‘æœ¬æœº)" "")
                if [[ -z "$domain_name" ]]; then
                    red "åŸŸåä¸èƒ½ä¸ºç©ºï¼å·²å–æ¶ˆåˆ›å»ºã€‚"
                    return 1
                fi

                # å°è¯•ç”³è¯·è¯ä¹¦ï¼Œå¦‚æœå¤±è´¥ç›´æ¥é€€å‡º
                if ! ax_get_certificate "$domain_name"; then
                    red "ACME è¯ä¹¦ç”³è¯·æµç¨‹å¤±è´¥ï¼Œå·²å–æ¶ˆåˆ›å»ºå®ä¾‹ã€‚"
                    return 1
                fi
                
                # åŒé‡æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
                if [ -f "$AX_CERT_DIR/$domain_name/fullchain.cer" ]; then
                    green "ACME éªŒè¯æˆåŠŸ. Hysteria2 å°†ä½¿ç”¨ $domain_name"
                    cert_path="$AX_CERT_DIR/$domain_name/fullchain.cer"
                    key_path="$AX_CERT_DIR/$domain_name/private.key"
                    sni="$domain_name"
                    masquerade_url="https://$domain_name"
                else
                    red "é”™è¯¯ï¼šæœªæ‰¾åˆ°ç”³è¯·çš„è¯ä¹¦æ–‡ä»¶ï¼Œå·²å–æ¶ˆåˆ›å»ºå®ä¾‹ã€‚"
                    return 1
                fi
            else
                # ç”¨æˆ·æ˜ç¡®é€‰æ‹©â€œå¦â€ï¼Œä½¿ç”¨è‡ªç­¾å
                generate_self_signed_cert
                cert_path="$HY2_CERT_PATH"
                key_path="$HY2_KEY_PATH"
                sni="$HY2_SNI"
                masquerade_url="$HY2_MASQUERADE_URL"
            fi
            
            replacements["__CERT_PATH__"]="$cert_path"
            replacements["__KEY_PATH__"]="$key_path"
            replacements["__MASQUERADE_URL__"]="$masquerade_url"
            
            log "å¯åŠ¨ä¸€ä¸ªæ–°çš„ ${TITLE} å®ä¾‹..."; next_id=$(find_next_available_id "$type")
            green "æ–°å®ä¾‹å°†è¢«åˆ›å»ºä¸º: ${SYSTEMD_SERVICE_NAME}@${next_id}.service"; cyan "--- é…ç½®æ–°å®ä¾‹ (ID: ${next_id}) ---"

            local listen_port=$(read_input "è¯·è¾“å…¥ç›‘å¬ç«¯å£ (ç•™ç©ºåˆ™éšæœºç”Ÿæˆ)" "")
            if [[ -z "$listen_port" ]]; then listen_port=$(find_available_port); green "å·²ä¸ºæ‚¨éšæœºé€‰æ‹©ç«¯å£: $listen_port"; fi
            replacements["__LISTEN__"]=":${listen_port}"
            
            # å¿½ç•¥å®¢æˆ·ç«¯å¸¦å®½
            local ignore_bw_choice=$(read_input_with_options "æ˜¯å¦å¿½ç•¥å®¢æˆ·ç«¯å¸¦å®½å»ºè®® (ignoreClientBandwidth)?" "1" "æ˜¯ (true, æ¨è)" "å¦ (false)")
            if [[ "$ignore_bw_choice" == "1" ]]; then replacements["__IGNORE_BW__"]="true"; else replacements["__IGNORE_BW__"]="false"; fi

            
    local enable_warp=$(read_input "æ˜¯å¦å¯ç”¨ WARP SOCKS5 åˆ†æµ [y/N]" "n")
            if [[ "$enable_warp" == "y" || "$enable_warp" == "Y" ]]; then
                local warp_port=$(read_input "è¯·è¾“å…¥ WARP SOCKS5 ç«¯å£" "$DEFAULT_WARP_SOCKS_PORT")
                local current_warp_addr="${DEFAULT_WARP_SOCKS_ADDR}:${warp_port}"; replacements["__OUTBOUNDS_AND_ACL__"]="${HYSTERIA2_WARP_OUTBOUND_ACL_BLOCK//__WARP_SOCKS5_ADDR__/${current_warp_addr}}"
                green "å·²å¯ç”¨ WARP SOCKS5 åˆ†æµ (åœ°å€: ${current_warp_addr})ã€‚"
            else
                replacements["__OUTBOUNDS_AND_ACL__"]="${HYSTERIA2_DIRECT_ACL_BLOCK}"; yellow "å·²ç¦ç”¨ WARP SOCKS5 åˆ†æµã€‚"
            fi
            
            replacements["__UDP_SNIFF_CONFIG__"]=""
            local password=$(handle_password_input "hysteria2")
            replacements["__PASSWORD__"]="$password"
            ;;

        udp2raw) TITLE="UDP2RAW"; INSTALL_DIR="$UDP2RAW_INSTALL_DIR"; SERVICE_PREFIX="udp2raw"; SYSTEMD_SERVICE_NAME="ax-udp2raw"; FILE_EXT="conf"; CONFIG_TEMPLATE="$UDP2RAW_CONFIG_TEMPLATE" 
            log "å¯åŠ¨ä¸€ä¸ªæ–°çš„ ${TITLE} å®ä¾‹..."; next_id=$(find_next_available_id "$type")
            green "æ–°å®ä¾‹å°†è¢«åˆ›å»ºä¸º: ${SYSTEMD_SERVICE_NAME}@${next_id}.service"; cyan "--- é…ç½®æ–°å®ä¾‹ (ID: ${next_id}) ---"
            local listen_addr=$(read_input "è¯·è¾“å…¥ç›‘å¬åœ°å€" "$DEFAULT_LISTEN_ADDR")
            local listen_port=$(read_input "è¯·è¾“å…¥ç›‘å¬ç«¯å£ (ç•™ç©ºåˆ™éšæœºç”Ÿæˆ)" "")
            if [[ -z "$listen_port" ]]; then listen_port=$(find_available_port); green "å·²ä¸ºæ‚¨éšæœºé€‰æ‹©ç«¯å£: $listen_port"; fi
            replacements["__LISTEN_ADDR__"]="${listen_addr}:${listen_port}"
            local target_host=$(read_input "è¯·è¾“å…¥ç›®æ ‡åœ°å€" "$DEFAULT_TARGET_ADDR")
            local target_port=$(read_input "è¯·è¾“å…¥ç›®æ ‡ç«¯å£ (ç•™ç©ºåˆ™éšæœºç”Ÿæˆ)" "")
            if [[ -z "$target_port" ]]; then target_port=$(find_available_port); green "å·²ä¸ºæ‚¨éšæœºé€‰æ‹©ç›®æ ‡ç«¯å£: $target_port"; fi
            replacements["__TARGET_ADDR__"]="${target_host}:${target_port}"
            
        # UDP2RAW å…³é”®å‚æ•°
            local raw_mode_opts=("faketcp" "udp" "icmp")
            local raw_mode_idx=$(read_input_with_options "è¯·é€‰æ‹© raw-mode (ä¼ªè£…æ¨¡å¼):" "1" "${raw_mode_opts[@]}")
            replacements["__RAW_MODE__"]="${raw_mode_opts[$((raw_mode_idx-1))]}"
            
            local cipher_mode_opts=("aes128cbc" "xor" "none")
            local cipher_mode_idx=$(read_input_with_options "è¯·é€‰æ‹© cipher-mode (åŠ å¯†æ¨¡å¼):" "1" "${cipher_mode_opts[@]}")
            replacements["__CIPHER_MODE__"]="${cipher_mode_opts[$((cipher_mode_idx-1))]}"
            
            local auth_mode_opts=("hmac_sha1" "md5" "crc32" "simple" "none")
            local auth_mode_idx=$(read_input_with_options "è¯·é€‰æ‹© auth-mode (è®¤è¯æ¨¡å¼):" "1" "${auth_mode_opts[@]}")
            replacements["__AUTH_MODE__"]="${auth_mode_opts[$((auth_mode_idx-1))]}"

            local password=$(handle_password_input "$type"); replacements["__PASSWORD__"]="$password"
            ;;
            
        kcptun) TITLE="KCPTUN"; INSTALL_DIR="$KCPTUN_INSTALL_DIR"; SERVICE_PREFIX="kcptun"; SYSTEMD_SERVICE_NAME="ax-kcptun"; FILE_EXT="json"; CONFIG_TEMPLATE="$KCPTUN_CONFIG_JSON_TEMPLATE" 
            log "å¯åŠ¨ä¸€ä¸ªæ–°çš„ ${TITLE} å®ä¾‹..."; next_id=$(find_next_available_id "$type")
            green "æ–°å®ä¾‹å°†è¢«åˆ›å»ºä¸º: ${SYSTEMD_SERVICE_NAME}@${next_id}.service"; cyan "--- é…ç½®æ–°å®ä¾‹ (ID: ${next_id}) ---"
            local listen_addr=$(read_input "è¯·è¾“å…¥ç›‘å¬åœ°å€" "$DEFAULT_LISTEN_ADDR")
            local listen_port=$(read_input "è¯·è¾“å…¥ç›‘å¬ç«¯å£ (ç•™ç©ºåˆ™éšæœºç”Ÿæˆ)" "")
            if [[ -z "$listen_port" ]]; then listen_port=$(find_available_port); green "å·²ä¸ºæ‚¨éšæœºé€‰æ‹©ç«¯å£: $listen_port"; fi
            replacements["__LISTEN__"]="${listen_addr}:${listen_port}"
            local target_host=$(read_input "è¯·è¾“å…¥ç›®æ ‡åœ°å€" "$DEFAULT_TARGET_ADDR")
            local target_port=$(read_input "è¯·è¾“å…¥ç›®æ ‡ç«¯å£ (ç•™ç©ºåˆ™éšæœºç”Ÿæˆ)" "")
            if [[ -z "$target_port" ]]; then target_port=$(find_available_port); green "å·²ä¸ºæ‚¨éšæœºé€‰æ‹©ç›®æ ‡ç«¯å£: $target_port"; fi
            replacements["__TARGET__"]="${target_host}:${target_port}"
            local mode_opts=("fast" "fast2" "fast3" "manual")
            local mode_idx=$(read_input_with_options "è¯·é€‰æ‹©åŠ é€Ÿæ¨¡å¼ (mode):" "3" "${mode_opts[@]}")
            replacements["__MODE__"]="${mode_opts[$((mode_idx-1))]}"
            local mtu=$(read_input "è¯·è¾“å…¥ MTU [é»˜è®¤:1350]" "1350")
            replacements["__MTU__"]="$mtu"
            local crypt_opts=("aes-128" "aes-192" "aes-256" "none")
            local crypt_idx=$(read_input_with_options "è¯·é€‰æ‹©åŠ å¯†æ–¹å¼ (crypt):" "1" "${crypt_opts[@]}")
            replacements["__CRYPT__"]="${crypt_opts[$((crypt_idx-1))]}"
            local sndwnd=$(read_input "è¯·è¾“å…¥å‘é€çª—å£å¤§å° (sndwnd) [é»˜è®¤:256]" "256")
            replacements["__SNDWND__"]="$sndwnd"
            local rcvwnd=$(read_input "è¯·è¾“å…¥æ¥æ”¶çª—å£å¤§å° (rcvwnd) [é»˜è®¤:2048]" "2048")
            replacements["__RCVWND__"]="$rcvwnd"
            local datashard=$(read_input "è¯·è¾“å…¥æ•°æ®åˆ†ç‰‡æ•° (datashard) [é»˜è®¤:10]" "10")
            replacements["__DATASHARD__"]="$datashard"
            local parityshard=$(read_input "è¯·è¾“å…¥çº é”™åˆ†ç‰‡æ•° (parityshard) [é»˜è®¤:3]" "3")
            replacements["__PARITYSHARD__"]="$parityshard"
            local tcp=$(read_input "æ˜¯å¦å¯ç”¨TCPæ¨¡å¼ (tcp) [é»˜è®¤:false] (true/false)" "false")
            replacements["__TCP__"]="$tcp"
            local password=$(handle_password_input "$type"); replacements["__KEY__"]="$password"
            ;;
            
        *) red "å†…éƒ¨é”™è¯¯: æ— æ•ˆçš„å®ä¾‹ç±»å‹ '$type'"; return 1 ;;
    esac

    log "ç”Ÿæˆé…ç½®æ–‡ä»¶..."; local temp_config="$CONFIG_TEMPLATE"; local conf_path="${INSTALL_DIR}/${SERVICE_PREFIX}_${next_id}.${FILE_EXT}"
# --- JQ Patch Start ---
    for placeholder in "${!replacements[@]}"; do 
        local raw_val="${replacements[${placeholder}]}"
        local safe_val="$raw_val"
        if [[ "$FILE_EXT" == "json" ]]; then safe_val=$(escape_json_val "$raw_val"); fi
        temp_config="${temp_config//${placeholder}/${safe_val}}"
    done
    if [[ "$FILE_EXT" == "json" ]] && command -v jq >/dev/null; then
        if ! echo "$temp_config" | jq . >/dev/null 2>&1; then
            red "ä¸¥é‡é”™è¯¯: ç”Ÿæˆçš„ JSON é…ç½®è¯­æ³•æ ¡éªŒå¤±è´¥ï¼ä¿ç•™é…ç½®ä¾›è°ƒè¯•ã€‚"
        fi
    fi
    # --- JQ Patch End ---
    
    deploy_service_instance "${SYSTEMD_SERVICE_NAME}@${next_id}.service" "$conf_path" "$temp_config" || return 1
    echo

    case "$type" in
        hysteria2) local sub_link=""; local retries=5; for ((i=1; i<=retries; i++)); do sub_link=$(generate_hy2_subscription_link $next_id); if [[ "$sub_link" != "N/A" ]]; then break; fi; sleep 0.5; done; cyan "è®¢é˜…é“¾æ¥: $sub_link";;
        udp2raw) view_udp2raw_client_config "$next_id" ;;
        kcptun) view_kcptun_client_config "$next_id" ;;
    esac
}

# åˆ›å»ºæ–°çš„ Xray å®ä¾‹ (VLESS+Reality, VLESS+mKCP, Shadowsocks)
create_new_xray_instance() {
    local type=$1; local next_id; local CONFIG_TEMPLATE TITLE
    declare -A replacements

    case "$type" in
        xray_reality) TITLE="VLESS+Reality"; CONFIG_TEMPLATE="$XRAY_VLESS_REALITY_TEMPLATE" ;;
        xray_mkcp) TITLE="VLESS+mKCP"; CONFIG_TEMPLATE="$XRAY_VLESS_MKCP_TEMPLATE" ;;
        xray_ss) TITLE="Shadowsocks"; CONFIG_TEMPLATE="$XRAY_SHADOWSOCKS_TCP_UDP_TEMPLATE" ;;
        *) red "å†…éƒ¨é”™è¯¯: æ— æ•ˆçš„ Xray ç±»å‹ '$type'"; return 1 ;;
    esac

    log "å¯åŠ¨ä¸€ä¸ªæ–°çš„ ${TITLE} å®ä¾‹..."; next_id=$(find_next_available_id "xray")
    green "æ–°å®ä¾‹å°†è¢«åˆ›å»ºä¸º: ax-xray@${next_id}.service"; cyan "--- é…ç½®æ–°å®ä¾‹ (ID: ${next_id}) ---"

    local listen_addr=$(read_input "è¯·è¾“å…¥ç›‘å¬åœ°å€" "$DEFAULT_LISTEN_ADDR")
    local listen_port=$(read_input "è¯·è¾“å…¥ç›‘å¬ç«¯å£ (ç•™ç©ºåˆ™éšæœºç”Ÿæˆ)" "")
    if [[ -z "$listen_port" ]]; then listen_port=$(find_available_port); green "å·²ä¸ºæ‚¨éšæœºé€‰æ‹©ç«¯å£: $listen_port"; fi
    
    replacements["__LISTEN_ADDR__"]="$listen_addr"
    replacements["__LISTEN_PORT__"]="$listen_port"

    # WARP åˆ†æµè®¾ç½®
    
    

    # åè®®ç‰¹å®šé…ç½®
    if [[ "$type" == "xray_reality" ]]; then
        local uuid=$(generate_strong_password); replacements["__UUID__"]="$uuid"
        local sni=$(read_input "è¯·è¾“å…¥ç›®æ ‡ç½‘ç«™ (SNI/Target)" "$XRAY_REALITY_DEFAULT_SNI")
        replacements["__SNI__"]="$sni"; replacements["__TARGET__"]="${sni}:443"
        
                # [FIX] å¢å¼ºå¯†é’¥ç”Ÿæˆä¸æ£€æŸ¥
                # [FIX] å¢å¼ºç‰ˆå¯†é’¥ç”Ÿæˆ (å…¼å®¹ v25+ ç‰ˆæœ¬è¾“å‡º)
        local key_pair=$("$XRAY_INSTALL_DIR/xray" x25519)
        if [[ -z "$key_pair" ]]; then red "é”™è¯¯: Xray å¯†é’¥ç”Ÿæˆå¤±è´¥"; return 1; fi

        # æå– Private Key (å…¼å®¹ "Private Key:" å’Œ "PrivateKey:")
        local private_key=$(echo "$key_pair" | grep -i "Private" | awk -F':' '{print $2}' | head -n1 | tr -d '[:space:]')
        
        # æå– Public Key (å…¼å®¹ "Public Key:", "Public:", å’Œ "Password:" - é’ˆå¯¹ç‰¹æ®Šç‰ˆæœ¬)
        local public_key=$(echo "$key_pair" | grep -i "Public" | awk -F':' '{print $2}' | head -n1 | tr -d '[:space:]')
        if [[ -z "$public_key" ]]; then
             # å°è¯•åŒ¹é… "Password:" ä½œä¸ºå¤‡é€‰å…¬é’¥æ ‡ç­¾
             public_key=$(echo "$key_pair" | grep -i "Password" | awk -F':' '{print $2}' | head -n1 | tr -d '[:space:]')
        fi

        if [[ -z "$private_key" || -z "$public_key" ]]; then
            red "é”™è¯¯: å¯†é’¥è§£æå¤±è´¥ï¼"
            yellow "Xray è¾“å‡ºè°ƒè¯•: $key_pair"
            return 1
        fi
        
        replacements["__PRIVATE_KEY__"]="$private_key"; replacements["__PUBLIC_KEY__"]="$public_key"
        
        local short_id=$(openssl rand -hex 8); replacements["__SHORT_ID__"]="$short_id"
        replacements["__REALITY_FLOW__"]="$XRAY_REALITY_DEFAULT_FLOW"
        replacements["__FINGERPRINT__"]="$XRAY_REALITY_DEFAULT_FP"
        
    elif [[ "$type" == "xray_mkcp" ]]; then
        local uuid=$(generate_strong_password); replacements["__UUID__"]="$uuid"
        local seed=$(handle_password_input "xray_mkcp"); replacements["__MKCP_SEED__"]="$seed"
        
        # mKCP å…³é”®å‚æ•°
        local mtu=$(read_input "è¯·è¾“å…¥ MTU (æœ€å¤§ä¼ è¾“å•å…ƒ)" "1350"); replacements["__MTU__"]="$mtu"
        local tti=$(read_input "è¯·è¾“å…¥ TTI (ä¼ è¾“æ—¶é—´é—´éš” ms)" "20"); replacements["__TTI__"]="$tti"
        local uplink=$(read_input "è¯·è¾“å…¥ uplinkCapacity (ä¸Šè¡Œå®¹é‡ MB/s)" "5"); replacements["__UPLINK__"]="$uplink"
        local downlink=$(read_input "è¯·è¾“å…¥ downlinkCapacity (ä¸‹è¡Œå®¹é‡ MB/s)" "20"); replacements["__DOWNLINK__"]="$downlink"
        
        local congestion_choice=$(read_input_with_options "æ˜¯å¦å¯ç”¨æ‹¥å¡æ§åˆ¶ (congestion)?" "1" "æ˜¯ (true)" "å¦ (false, æ¨è)")
        if [[ "$congestion_choice" == "1" ]]; then replacements["__CONGESTION__"]="true"; else replacements["__CONGESTION__"]="false"; fi
        
        local read_buf=$(read_input "è¯·è¾“å…¥ readBufferSize (è¯»å–ç¼“å†²åŒº MB)" "2"); replacements["__READ_BUF__"]="$read_buf"
        local write_buf=$(read_input "è¯·è¾“å…¥ writeBufferSize (å†™å…¥ç¼“å†²åŒº MB)" "2"); replacements["__WRITE_BUF__"]="$write_buf"
        
        local header_opts=("none" "srtp" "utp" "wechat-video" "dtls" "wireguard")
        local header_idx=$(read_input_with_options "è¯·é€‰æ‹©ä¼ªè£…å¤´ç±»å‹ (header type):" "4" "${header_opts[@]}")
        replacements["__HEADER_TYPE__"]="${header_opts[$((header_idx-1))]}"

        elif [[ "$type" == "xray_ss" ]]; then
        local ss_method_opts=("2022-blake3-aes-128-gcm" "2022-blake3-aes-256-gcm" "2022-blake3-chacha20-poly1305" "aes-128-gcm" "aes-256-gcm" "chacha20-ietf-poly1305")
        local ss_method_idx=$(read_input_with_options "è¯·é€‰æ‹© Shadowsocks åŠ å¯†æ–¹å¼:" "2" "${ss_method_opts[@]}")
        local method="${ss_method_opts[$((ss_method_idx-1))]}"
        replacements["__SS_METHOD__"]="$method"
        
        local password=$(handle_password_input "shadowsocks" "$method")
        replacements["__SS_PASSWORD__"]="$password"
    fi

    local enable_warp=$(read_input "æ˜¯å¦å¯ç”¨ WARP SOCKS5 åˆ†æµ [y/N]" "n")
    if [[ "$enable_warp" == "y" || "$enable_warp" == "Y" ]]; then
        local warp_port=$(read_input "è¯·è¾“å…¥ WARP SOCKS5 ç«¯å£" "$DEFAULT_WARP_SOCKS_PORT")
        local current_warp_addr="${DEFAULT_WARP_SOCKS_ADDR}"; 
        replacements["__OUTBOUNDS_AND_ROUTING__"]="${XRAY_WARP_OUTBOUND_AND_ROUTING_BLOCK//__WARP_SOCKS5_ADDR__/${current_warp_addr}}"
        replacements["__OUTBOUNDS_AND_ROUTING__"]="${replacements[__OUTBOUNDS_AND_ROUTING__]//__WARP_SOCKS5_PORT__/${warp_port}}"
        green "å·²å¯ç”¨ WARP SOCKS5 åˆ†æµ (åœ°å€: ${current_warp_addr}:${warp_port})ã€‚"
    else
        replacements["__OUTBOUNDS_AND_ROUTING__"]="${XRAY_DIRECT_OUTBOUND_AND_ROUTING_BLOCK}"; yellow "å·²ç¦ç”¨ WARP SOCKS5 åˆ†æµã€‚"
    fi

    log "ç”Ÿæˆé…ç½®æ–‡ä»¶..."; local temp_config="$CONFIG_TEMPLATE"; local conf_path="${XRAY_INSTALL_DIR}/xray_${next_id}.json"
# --- JQ Patch Start ---
    for placeholder in "${!replacements[@]}"; do 
        local raw_val="${replacements[${placeholder}]}"
        local safe_val="$raw_val"
        if [[ "$FILE_EXT" == "json" ]]; then safe_val=$(escape_json_val "$raw_val"); fi
        temp_config="${temp_config//${placeholder}/${safe_val}}"
    done
    if [[ "$FILE_EXT" == "json" ]] && command -v jq >/dev/null; then
        if ! echo "$temp_config" | jq . >/dev/null 2>&1; then
            red "ä¸¥é‡é”™è¯¯: ç”Ÿæˆçš„ JSON é…ç½®è¯­æ³•æ ¡éªŒå¤±è´¥ï¼ä¿ç•™é…ç½®ä¾›è°ƒè¯•ã€‚"
        fi
    fi
    # --- JQ Patch End ---

    deploy_service_instance "ax-xray@${next_id}.service" "$conf_path" "$temp_config" || return 1
    echo

    case "$type" in
        xray_reality) green "VLESS+Reality é“¾æ¥: $(generate_xray_reality_link $next_id)";;
        xray_mkcp) green "VLESS+mKCP é“¾æ¥: $(generate_xray_mkcp_link $next_id)";;
        xray_ss) green "Shadowsocks é“¾æ¥: $(generate_xray_ss_link $next_id)";;
    esac
}
# --- 14. å®¢æˆ·ç«¯é…ç½®æŸ¥çœ‹å™¨ ---

# ç”Ÿæˆ Hysteria2 è®¢é˜…é“¾æ¥
generate_hy2_subscription_link() {
    local id=$1; local conf="$HY2_INSTALL_DIR/hy2_${id}.yaml"; if [[ ! -s "$conf" ]]; then echo "N/A"; return; fi
    
    local password=$(grep -Po '(?<=password: ).*' "$conf" | tr -d '[:space:]')
    local port_info=$(get_listen_info_from_conf "$conf")
    local port=$(echo "$port_info" | awk -F':' '{print $NF}')
    local ip=$(get_public_ip)
    
    # åŠ¨æ€å†³å®š SNI å’Œ insecure æ ‡è®°
    local cert_path=$(grep -Po '(?<=cert: ).*' "$conf" | tr -d '[:space:]')
    local sni=""
    local insecure_flag=0 # é»˜è®¤å®‰å…¨
    
    if [[ "$cert_path" == *"$AX_CERT_DIR"* ]]; then
        # æ˜¯ ACME è¯ä¹¦, ä»è·¯å¾„ä¸­æå–åŸŸå
        sni=$(echo "$cert_path" | cut -d'/' -f4)
        insecure_flag=0 # çœŸå®è¯ä¹¦ï¼Œå®‰å…¨
    else
        # æ˜¯è‡ªç­¾åè¯ä¹¦
        sni="$HY2_SNI" # é»˜è®¤ bing.com
        insecure_flag=$HY2_CLIENT_INSECURE # ä½¿ç”¨å…¨å±€ä¸å®‰å…¨æ ‡è®° (1)
    fi
    
    # ä½¿ç”¨ sni ä½œä¸ºæ ‡è¯† (å¦‚æœæœ‰)
    local host_label=$ip
    if [[ "$sni" != "$HY2_SNI" && -n "$sni" ]]; then
        host_label=$sni
    fi

    echo "hysteria2://${password}@${ip}:${port}?sni=${sni}&insecure=${insecure_flag}#hy2_${host_label}_${id}"
}

# ç”Ÿæˆ VLESS+Reality åˆ†äº«é“¾æ¥
generate_xray_reality_link() {
    local id=$1; local conf="$XRAY_INSTALL_DIR/xray_${id}.json"; if [[ ! -s "$conf" ]]; then echo "N/A"; return; fi
    local ip=$(get_public_ip)
    local port=$(jq -r '.inbounds[0].port' "$conf")
    local uuid=$(jq -r '.inbounds[0].settings.clients[0].id' "$conf")
    local sni=$(jq -r '.inbounds[0].streamSettings.realitySettings.serverNames[0]' "$conf")
    local pbk=$(jq -r '.inbounds[0].streamSettings.realitySettings.publicKey' "$conf")
    local sid=$(jq -r '.inbounds[0].streamSettings.realitySettings.shortIds[0]' "$conf")
    local flow=$(jq -r '.inbounds[0].settings.clients[0].flow' "$conf")
    local fp=$(jq -r '.inbounds[0].streamSettings.realitySettings.fingerprint' "$conf")

    local link="vless://${uuid}@${ip}:${port}?type=tcp&security=reality&sni=${sni}&pbk=${pbk}&flow=${flow}&sid=${sid}&fp=${fp}#Xray_Reality_${ip}_${id}"
    echo "$link"
}

# ç”Ÿæˆ VLESS+mKCP åˆ†äº«é“¾æ¥
generate_xray_mkcp_link() {
    local id=$1; local conf="$XRAY_INSTALL_DIR/xray_${id}.json"; if [[ ! -s "$conf" ]]; then echo "N/A"; return; fi
    local ip=$(get_public_ip)
    local port=$(jq -r '.inbounds[0].port' "$conf")
    local uuid=$(jq -r '.inbounds[0].settings.clients[0].id' "$conf")
    local seed=$(jq -r '.inbounds[0].streamSettings.kcpSettings.seed' "$conf")
    local header_type=$(jq -r '.inbounds[0].streamSettings.kcpSettings.header.type' "$conf")
    
    local link="vless://${uuid}@${ip}:${port}?type=kcp&security=none&headerType=${header_type}&seed=${seed}#Xray_mKCP_${ip}_${id}"
    echo "$link"
}

# ç”Ÿæˆ Shadowsocks åˆ†äº«é“¾æ¥
generate_xray_ss_link() {
    local id=$1; local conf="$XRAY_INSTALL_DIR/xray_${id}.json"; if [[ ! -s "$conf" ]]; then echo "N/A"; return; fi
    local ip=$(get_public_ip)
    local port_info=$(get_listen_info_from_conf "$conf")
    local port=$(echo "$port_info" | awk -F':' '{print $NF}')
    local password=$(jq -r '.inbounds[0].settings.password' "$conf")
    local method=$(jq -r '.inbounds[0].settings.method' "$conf")
    
    # Base64 encode: method:password
    local user_info=$(echo -n "${method}:${password}" | base64 | tr -d '\n' | sed 's/=*$//') # Remove padding
    
    local link="ss://${user_info}@${ip}:${port}#SS_${ip}_${id}"
    echo "$link"
}

# æŸ¥çœ‹æ‰€æœ‰ Hysteria2 ç‹¬ç«‹å®ä¾‹çš„è®¢é˜…é“¾æ¥
view_all_hy2_subscriptions() {
    local INSTANCES=$(get_standalone_instances "hysteria2"); if [[ -z "$INSTANCES" ]]; then yellow "æœªæ‰¾åˆ°ä»»ä½• Hysteria2 ç‹¬ç«‹å®ä¾‹ã€‚"; return; fi
    cyan "--- Hysteria2 ç‹¬ç«‹å®ä¾‹è®¢é˜…é“¾æ¥ ---"; for id in $INSTANCES; do green "å®ä¾‹ ${id}: $(generate_hy2_subscription_link $id)"; done
}

# æŸ¥çœ‹ UDP2RAW å®¢æˆ·ç«¯é…ç½®
view_udp2raw_client_config(){
    local id=$1; local conf="$UDP2RAW_INSTALL_DIR/udp2raw_${id}.conf"; if [[ ! -s "$conf" ]]; then red "é”™è¯¯: æœªæ‰¾åˆ°å®ä¾‹ $id çš„é…ç½®æ–‡ä»¶æˆ–æ–‡ä»¶ä¸ºç©ºã€‚"; return; fi
    local ip=$(get_public_ip); local port=$(get_listen_info_from_conf "$conf" | awk -F':' '{print $NF}')
    local password=$(grep -Po '(?<=-k )[^ ]+' "$conf")
    local raw_mode=$(grep -Po '(?<=--raw-mode )[^ ]+' "$conf")
    local cipher_mode=$(grep -Po '(?<=--cipher-mode )[^ ]+' "$conf")
    local auth_mode=$(grep -Po '(?<=--auth-mode )[^ ]+' "$conf")
    
    local args="-c -l ${CLIENT_UDP2RAW_LISTEN_ADDR} -r ${ip}:${port} -k ${password} --raw-mode ${raw_mode} --cipher-mode ${cipher_mode} --auth-mode ${auth_mode} --seq-mode 4 -a --keep-rule --fix-gro"
    
    cyan "--- UDP2RAW å®ä¾‹ ${id} å®¢æˆ·ç«¯é…ç½® ---";  echo
    green "$args"
}

# æŸ¥çœ‹ KCPTUN å®¢æˆ·ç«¯é…ç½®
view_kcptun_client_config(){
    local id=$1; local conf="$KCPTUN_INSTALL_DIR/kcptun_${id}.json"; if [[ ! -s "$conf" ]]; then red "é”™è¯¯: æœªæ‰¾åˆ°å®ä¾‹ $id çš„é…ç½®æ–‡ä»¶æˆ–æ–‡ä»¶ä¸ºç©ºã€‚"; return; fi
    if ! command -v jq &>/dev/null; then red "é”™è¯¯: jq æœªå®‰è£…ï¼Œæ— æ³•è§£æé…ç½®ã€‚"; return; fi
    local ip=$(get_public_ip); local server_listen=$(jq -r '.listen' "$conf"); local server_port=$(echo "$server_listen" | awk -F':' '{print $NF}'); cyan "--- KCPTUN å®ä¾‹ ${id} å®¢æˆ·ç«¯é…ç½® ---"; echo
    
    yellow "æ–¹æ³•ä¸€: ä½¿ç”¨é…ç½®æ–‡ä»¶ (æ¨è)"; yellow "ä¿å­˜ä»¥ä¸‹å†…å®¹ä¸º client.jsonï¼Œç„¶åè¿è¡Œ: kcptun_client -c client.json"; 
    # ç”Ÿæˆå¯¹åº”çš„å®¢æˆ·ç«¯ JSON (åè½¬ listen/target)
    jq --arg ip "$ip" --arg port "$server_port" --arg listen "$CLIENT_KCPTUN_LISTEN_ADDR" '.remote = ($ip + ":" + $port) | .local = $listen | del(.listen, .target)' "$conf" | green_cat
    echo
    yellow "æ–¹æ³•äºŒ: ä½¿ç”¨å‘½ä»¤è¡Œå‚æ•°"; yellow "åœ¨å®¢æˆ·ç«¯ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤è¡Œå‚æ•° (æœ¬åœ°ç›‘å¬åœ°å€ ${CLIENT_KCPTUN_LISTEN_ADDR} å¯è‡ªè¡Œä¿®æ”¹):";local args="--listen ${CLIENT_KCPTUN_LISTEN_ADDR} --target ${ip}:${server_port}"
    for key in $(jq -r 'keys_unsorted | .[]' "$conf"); do if [[ "$key" != "listen" && "$key" != "target" ]]; then local value=$(jq -r --arg k "$key" '.[$k]' "$conf"); args+=" --${key} ${value}"; fi; done; green "$args"; echo
}

# --- 15. ç»„ä»¶ä¸²è”å®ä¾‹ç®¡ç† (SS+KCP+UDP) ---

# è·å– 3 ç»„ä»¶ä¸²è”å®ä¾‹IDåˆ—è¡¨ (ss_3_chain)
get_chain_instances_3() {
    local instances1=$(ls -1 "$XRAY_INSTALL_DIR"/xray_s3c*.json 2>/dev/null | sed -E 's/.*_s3c([0-9]+).*/\1/')
    local instances2=$(ls -1 "$KCPTUN_INSTALL_DIR"/kcptun_s3c*.json 2>/dev/null | sed -E 's/.*_s3c([0-9]+).*/\1/')
    local instances3=$(ls -1 "$UDP2RAW_INSTALL_DIR"/udp2raw_s3c*.conf 2>/dev/null | sed -E 's/.*_s3c([0-9]+).*/\1/')
    echo "$instances1 $instances2 $instances3" | tr ' ' '\n' | sort -un
}

# æŸ¥çœ‹ 3 ç»„ä»¶ä¸²è”å®ä¾‹çš„å®¢æˆ·ç«¯é…ç½®
view_chain_client_config_3() {
    local id_num=$1
    local id="s3c${id_num}"
    local ss_conf_path="$XRAY_INSTALL_DIR/xray_${id}.json"
    local kcptun_conf_path="$KCPTUN_INSTALL_DIR/kcptun_${id}.json"
    local udp2raw_conf_path="$UDP2RAW_INSTALL_DIR/udp2raw_${id}.conf"
    
    if [[ ! -f "$ss_conf_path" || ! -f "$kcptun_conf_path" || ! -f "$udp2raw_conf_path" ]]; then
        red "ä¸²è”å®ä¾‹ ${id} çš„é…ç½®æ–‡ä»¶ä¸å®Œæ•´ã€‚"; return
    fi
    
    local ip=$(get_public_ip)
    local udp2raw_port=$(get_listen_info_from_conf "$udp2raw_conf_path" | awk -F':' '{print $NF}')
    local udp2raw_password=$(grep -Po '(?<=-k )[^ ]+' "$udp2raw_conf_path")
    local raw_mode=$(grep -Po '(?<=--raw-mode )[^ ]+' "$udp2raw_conf_path")
    local cipher_mode=$(grep -Po '(?<=--cipher-mode )[^ ]+' "$udp2raw_conf_path")
    local auth_mode=$(grep -Po '(?<=--auth-mode )[^ ]+' "$udp2raw_conf_path")
    
    local client_args_udp2raw="-c -r ${ip}:${udp2raw_port} -l ${CLIENT_SS_3_CHAIN_UDP2RAW_LISTEN_ADDR} -k ${udp2raw_password} --raw-mode ${raw_mode} --cipher-mode ${cipher_mode} --auth-mode ${auth_mode} --seq-mode 4 -a --keep-rule --fix-gro"
    local client_udp2raw_host="127.0.0.1"
    local client_udp2raw_port=$(echo "$CLIENT_SS_3_CHAIN_UDP2RAW_LISTEN_ADDR" | cut -d: -f2)
    
    local kcp_args="--listen ${CLIENT_SS_3_CHAIN_KCPTUN_LISTEN_ADDR} --target ${client_udp2raw_host}:${client_udp2raw_port}"
    for key in $(jq -r 'keys_unsorted | .[]' "$kcptun_conf_path"); do if [[ "$key" != "listen" && "$key" != "target" ]]; then local value=$(jq -r --arg k "$key" '.[$k]' "$kcptun_conf_path"); kcp_args+=" --${key} ${value}"; fi; done
    
    local ss_user_info=$(jq -r '.inbounds[0].settings.method + ":" + .inbounds[0].settings.password' "$ss_conf_path" | base64 | tr -d '\n' | sed 's/=*$//')
    local ss_host="127.0.0.1" # å¼ºåˆ¶æœ¬åœ°å›ç¯
    local ss_port=$(echo "$CLIENT_SS_3_CHAIN_SS_TARGET" | cut -d: -f2)
    
    # ç»Ÿä¸€å‘½åæ ¼å¼ä¸º Chain_ss_kcp_... +UDP2RAW
    local sub_link="ss://${ss_user_info}@${ss_host}:${ss_port}#Chain_ss_kcp_${ip}_${id}+UDP2RAW"
    green "$sub_link"; echo
    
    echo
    yellow "[SS+KCPTUN+UDP2RAW] åˆå¹¶è®¢é˜…é“¾æ¥ (å¤åˆ¶ä»¥ä¸‹æ•´è¡Œ):"
    green "CHAIN##${sub_link} && KCPTUN://${kcp_args} && UDP2RAW://${client_args_udp2raw}"
    echo
}

# å¯åŠ¨ä¸€ä¸ªæ–°çš„ 3 ç»„ä»¶ä¸²è”å®ä¾‹ (SS+KCP+UDP)
start_new_chain_instance_3() {
    local i=1
    while true; do if [[ ! -f "$XRAY_INSTALL_DIR/xray_s3c${i}.json" ]]; then break; fi; i=$((i + 1)); done
    
    local chain_id="s3c${i}"
    log "å¯åŠ¨ä¸€ä¸ªæ–°çš„ SS+KCP+UDP ä¸²è”å®ä¾‹ (å…¨è‡ªåŠ¨)..."
    green "æ–°ä¸²è”å®ä¾‹å°†è¢«åˆ›å»ºä¸º: ${chain_id}"
    
    # --- Step 1: UDP2RAW ---
    echo; cyan "=== 1. é…ç½® UDP2RAW (æœ€å¤–å±‚) ==="
    local udp2raw_listen_port=$(read_input "è¯·è¾“å…¥å¯¹å¤–ç›‘å¬ç«¯å£ (UDP2RAW) (ç•™ç©ºåˆ™éšæœº)" "")
    if [[ -z "$udp2raw_listen_port" ]]; then udp2raw_listen_port=$(find_available_port); green "å·²è‡ªåŠ¨é€‰æ‹©å¯¹å¤–ç«¯å£: $udp2raw_listen_port"; else if check_port_occupied "$udp2raw_listen_port"; then red "ç«¯å£å ç”¨ï¼"; return; fi; fi
    
    local udp2raw_password=$(handle_password_input "udp2raw")
    
    local raw_mode_opts=("faketcp" "udp" "icmp")
    local raw_mode_idx=$(read_input_with_options "è¯·é€‰æ‹© UDP2RAW raw-mode (ä¼ªè£…æ¨¡å¼):" "1" "${raw_mode_opts[@]}")
    local raw_mode="${raw_mode_opts[$((raw_mode_idx-1))]}"
    
    local cipher_mode_opts=("aes128cbc" "xor" "none")
    local cipher_mode_idx=$(read_input_with_options "è¯·é€‰æ‹© cipher-mode (åŠ å¯†æ¨¡å¼):" "1" "${cipher_mode_opts[@]}")
    local cipher_mode="${cipher_mode_opts[$((cipher_mode_idx-1))]}"
    
    local auth_mode_opts=("hmac_sha1" "md5" "crc32" "simple" "none")
    local auth_mode_idx=$(read_input_with_options "è¯·é€‰æ‹© auth-mode (è®¤è¯æ¨¡å¼):" "1" "${auth_mode_opts[@]}")
    local auth_mode="${auth_mode_opts[$((auth_mode_idx-1))]}"

    # --- Step 2: KCPTUN ---
    echo; cyan "=== 2. é…ç½® KCPTUN (ä¸­é—´å±‚) ==="
    local kcptun_listen_port=$(find_available_port)
    green "KCPTUN ç›‘å¬ç«¯å£å·²è‡ªåŠ¨åˆ†é…: $kcptun_listen_port"
    local kcptun_key=$(handle_password_input "kcptun")

    # --- Step 3: Shadowsocks ---
    echo; cyan "=== 3. é…ç½® Shadowsocks (æœ€å†…å±‚) ==="
    local ss_listen_port=$(find_available_port)
    green "Shadowsocks ç›‘å¬ç«¯å£å·²è‡ªåŠ¨åˆ†é…: $ss_listen_port"
    
    # [Change] å…ˆé€‰åŠ å¯†æ–¹å¼
    local ss_method_opts=("2022-blake3-aes-128-gcm" "2022-blake3-aes-256-gcm" "2022-blake3-chacha20-poly1305" "aes-128-gcm" "aes-256-gcm" "chacha20-ietf-poly1305")
    local ss_method_idx=$(read_input_with_options "è¯·é€‰æ‹© Shadowsocks åŠ å¯†æ–¹å¼:" "2" "${ss_method_opts[@]}")
    local ss_method="${ss_method_opts[$((ss_method_idx-1))]}"
    
    # [Change] åç”Ÿæˆå¯†ç  (ä¼ å…¥ method ä»¥å†³å®šé•¿åº¦)
    local ss_password=$(handle_password_input "shadowsocks" "$ss_method")

    # --- Step 4: WARP ---
    echo; cyan "=== 4. é…ç½® WARP åˆ†æµ ==="
    local enable_warp=$(read_input "æ˜¯å¦å¯ç”¨ WARP SOCKS5 åˆ†æµ [y/N]" "n")
    local warp_config_block=""
    if [[ "$enable_warp" == "y" || "$enable_warp" == "Y" ]]; then
        local warp_addr="$DEFAULT_WARP_SOCKS_ADDR"
        local warp_port=$(read_input "è¯·è¾“å…¥ WARP SOCKS5 ç«¯å£" "$DEFAULT_WARP_SOCKS_PORT")
        warp_config_block=$XRAY_WARP_OUTBOUND_AND_ROUTING_BLOCK
        warp_config_block=${warp_config_block/__WARP_SOCKS5_ADDR__/$warp_addr}
        warp_config_block=${warp_config_block/__WARP_SOCKS5_PORT__/$warp_port}
        green "å·²å¯ç”¨ WARP (åœ°å€: ${warp_addr}:${warp_port})"
    else
        warp_config_block=$XRAY_DIRECT_OUTBOUND_AND_ROUTING_BLOCK
        yellow "å·²ç¦ç”¨ WARP"
    fi

    # --- ç”Ÿæˆé…ç½® ---
    # 1. SS
    local ss_config="$XRAY_SHADOWSOCKS_TCP_UDP_TEMPLATE"
    ss_config="${ss_config//__LISTEN_ADDR__/127.0.0.1}"
    ss_config="${ss_config//__LISTEN_PORT__/${ss_listen_port}}"
    ss_config="${ss_config//__SS_METHOD__/${ss_method}}"
    ss_config="${ss_config//__SS_PASSWORD__/${ss_password}}"
    ss_config=${ss_config/__OUTBOUNDS_AND_ROUTING__/$warp_config_block}
    local ss_conf_path="$XRAY_INSTALL_DIR/xray_${chain_id}.json"
    
    # 2. KCP
    local kcp_config="$KCPTUN_CONFIG_JSON_TEMPLATE"
    kcp_config="${kcp_config//__LISTEN__/127.0.0.1:${kcptun_listen_port}}"
    kcp_config="${kcp_config//__TARGET__/127.0.0.1:${ss_listen_port}}"
    kcp_config="${kcp_config//__KEY__/${kcptun_key}}"
    kcp_config="${kcp_config//__MODE__/$KCPTUN_DEFAULT_MODE}"
    kcp_config="${kcp_config//__MTU__/1350}"
    kcp_config="${kcp_config//__CRYPT__/aes-128}"
    kcp_config="${kcp_config//__SNDWND__/256}"
    kcp_config="${kcp_config//__RCVWND__/2048}"
    kcp_config="${kcp_config//__DATASHARD__/10}"
    kcp_config="${kcp_config//__PARITYSHARD__/3}"
    kcp_config="${kcp_config//__TCP__/false}"
    local kcp_conf_path="$KCPTUN_INSTALL_DIR/kcptun_${chain_id}.json"
    
    # 3. UDP2RAW
    local udp_config="${UDP2RAW_CONFIG_TEMPLATE}"
    udp_config="${udp_config//__LISTEN_ADDR__/0.0.0.0:${udp2raw_listen_port}}"
    udp_config="${udp_config//__TARGET_ADDR__/127.0.0.1:${kcptun_listen_port}}"
    udp_config="${udp_config//__PASSWORD__/${udp2raw_password}}"
    udp_config="${udp_config//__RAW_MODE__/${raw_mode}}"
    udp_config="${udp_config//__CIPHER_MODE__/${cipher_mode}}"
    udp_config="${udp_config//__AUTH_MODE__/${auth_mode}}"
    local udp_conf_path="$UDP2RAW_INSTALL_DIR/udp2raw_${chain_id}.conf"

    log "ç”Ÿæˆé…ç½®æ–‡ä»¶..."
    deploy_service_instance "ax-xray@${chain_id}.service" "$ss_conf_path" "$ss_config" || return 1
    deploy_service_instance "ax-kcptun@${chain_id}.service" "$kcp_conf_path" "$kcp_config" || return 1
    deploy_service_instance "ax-udp2raw@${chain_id}.service" "$udp_conf_path" "$udp_config" || return 1
    
    sleep 1; green "ä¸²è”å®ä¾‹ ${chain_id} å·²å¯åŠ¨ï¼"; echo
    view_chain_client_config_3 "$i"
}

# ç®¡ç†ä¸€ä¸ªå·²å­˜åœ¨çš„ 3 ç»„ä»¶ä¸²è”å®ä¾‹
manage_chain_instance_3() {
    local id_num=$1
    local manage_id="s3c${id_num}"
    
    local service1_full="ax-xray@${manage_id}.service" # SS
    local service2_full="ax-kcptun@${manage_id}.service"        # KCP
    local service3_full="ax-udp2raw@${manage_id}.service"        # UDP2RAW
    
    local conf1_path="$XRAY_INSTALL_DIR/xray_${manage_id}.json"
    local conf2_path="$KCPTUN_INSTALL_DIR/kcptun_${manage_id}.json"
    local conf3_path="$UDP2RAW_INSTALL_DIR/udp2raw_${manage_id}.conf"
    
    while true; do
        clear; echo "=================================="; echo "   ç®¡ç† SS+KCP+UDP $(dim "${manage_id}")"; echo "=================================="
        read -r color s1_status s2_status s3_status <<< "$(check_services_status "$service1_full" "$service2_full" "$service3_full")"
        local udp2raw_info=$(get_listen_info_from_conf "$conf3_path")
        
        $color "çŠ¶æ€: SS [${s1_status}] + KCP [${s2_status}] + UDP2RAW [${s3_status}] $(dim "$udp2raw_info")"

        echo "----------------------------------"; echo "1) å¯åŠ¨/é‡å¯æ­¤ä¸²è”"; echo "2) åœæ­¢æ­¤ä¸²è”"; echo "3) æŸ¥çœ‹å®¢æˆ·ç«¯é…ç½®æŒ‡å—"; echo "4) æŸ¥çœ‹ SS (Xray) æ—¥å¿—"; echo "5) æŸ¥çœ‹ KCPTUN æ—¥å¿—"; echo "6) æŸ¥çœ‹ UDP2RAW æ—¥å¿—"; echo "7) ç¼–è¾‘ SS (Xray) é…ç½®æ–‡ä»¶"; echo "8) ç¼–è¾‘ KCPTUN é…ç½®æ–‡ä»¶"; echo "9) ç¼–è¾‘ UDP2RAW é…ç½®æ–‡ä»¶"; echo "99) å½»åº•åˆ é™¤æ­¤ä¸²è”"; echo "0) è¿”å›"
        read -p "è¯·é€‰æ‹©: " manage_choice
        case $manage_choice in
            1) log "é‡å¯ä¸²è”..."; systemctl restart "$service1_full" "$service2_full" "$service3_full";;
            2) log "åœæ­¢ä¸²è”..."; systemctl stop "$service1_full" "$service2_full" "$service3_full";;
            3) view_chain_client_config_3 "$id_num"; read -p $'\næŒ‰ä»»æ„é”®è¿”å›...' -n1 -s;;
            4) log "æ­£åœ¨å®æ—¶è·Ÿè¸ª SS (Xray) æ—¥å¿—... (æŒ‰ Ctrl+C ä»…é€€å‡ºæ—¥å¿—)"; local ct=$(trap -p SIGINT); trap ':' SIGINT; journalctl -u "$service1_full" -f; eval "$ct";;
            5) log "æ­£åœ¨å®æ—¶è·Ÿè¸ª KCPTUN æ—¥å¿—... (æŒ‰ Ctrl+C ä»…é€€å‡ºæ—¥å¿—)"; local ct=$(trap -p SIGINT); trap ':' SIGINT; journalctl -u "$service2_full" -f; eval "$ct";;
            6) log "æ­£åœ¨å®æ—¶è·Ÿè¸ª UDP2RAW æ—¥å¿—... (æŒ‰ Ctrl+C ä»…é€€å‡ºæ—¥å¿—)"; local ct=$(trap -p SIGINT); trap ':' SIGINT; journalctl -u "$service3_full" -f; eval "$ct";;
            7) nano "$conf1_path"; systemctl restart "$service1_full";;
            8) nano "$conf2_path"; systemctl restart "$service2_full";;
            9) nano "$conf3_path"; systemctl restart "$service3_full";;
            99) read -p "ç¡®è®¤åˆ é™¤ä¸²è”å®ä¾‹ ${manage_id}ï¼Ÿ(é»˜è®¤â€œå¦â€) [y/N]: " del_confirm; if [[ "$del_confirm" == "y" ]]; then 
                log "åˆ é™¤ä¸²è”..."; 
                systemctl stop "$service1_full" "$service2_full" "$service3_full"; 
                systemctl disable "$service1_full" "$service2_full" "$service3_full" >/dev/null 2>&1; 
                rm -f "$conf1_path" "$conf2_path" "$conf3_path"; 
                systemctl daemon-reload; green "å·²åˆ é™¤ã€‚"; break; 
                fi;;
            0) break;; *) red "æ— æ•ˆè¾“å…¥";;
        esac
        [[ "$manage_choice" == "1" || "$manage_choice" == "2" || "$manage_choice" == "7" || "$manage_choice" == "8" || "$manage_choice" == "9" ]] && read -p $'\næŒ‰ä»»æ„é”®è¿”å›...' -n1 -s
    done
}


# --- 16. [åˆå¹¶] 2 ç»„ä»¶ä¸²è”å®ä¾‹ç®¡ç† (Hysteria2 / VLESS) ---

# è·å– 2 ç»„ä»¶ä¸²è”å®ä¾‹IDåˆ—è¡¨ (hy2 æˆ– vless)
get_chain_instances() {
    local chain_type=$1
    local instances1="" instances2=""
    if [[ "$chain_type" == "hy2" ]]; then
        instances1=$(ls -1 "$HY2_INSTALL_DIR"/hy2_c*.yaml 2>/dev/null | sed -E 's/.*_c([0-9]+).*/\1/')
        instances2=$(ls -1 "$UDP2RAW_INSTALL_DIR"/udp2raw_c*.conf 2>/dev/null | sed -E 's/.*_c([0-9]+).*/\1/')
    else # vless
        instances1=$(ls -1 "$XRAY_INSTALL_DIR"/xray_vc*.json 2>/dev/null | sed -E 's/.*_vc([0-9]+).*/\1/')
        instances2=$(ls -1 "$UDP2RAW_INSTALL_DIR"/udp2raw_vc*.conf 2>/dev/null | sed -E 's/.*_vc([0-9]+).*/\1/')
    fi
    echo "$instances1 $instances2" | tr ' ' '\n' | sort -un
}

# æŸ¥çœ‹ 2 ç»„ä»¶ä¸²è”å®ä¾‹çš„å®¢æˆ·ç«¯é…ç½®
view_chain_client_config() {
    local chain_type=$1 id_num=$2
    local id_prefix="" main_conf_path="" client_listen_addr="" title=""
    if [[ "$chain_type" == "hy2" ]]; then
        id_prefix="c"; title="Hysteria2"; main_conf_path="$HY2_INSTALL_DIR/hy2_c${id_num}.yaml"; client_listen_addr="$CLIENT_UDP2RAW_LISTEN_ADDR"
    else
        id_prefix="vc"; title="VLESS_mKCP"; main_conf_path="$XRAY_INSTALL_DIR/xray_vc${id_num}.json"; client_listen_addr="$CLIENT_VLESS_UDP2RAW_LISTEN_ADDR"
    fi
    local id="${id_prefix}${id_num}"
    local udp2raw_conf="$UDP2RAW_INSTALL_DIR/udp2raw_${id}.conf"
    if [[ ! -f "$main_conf_path" || ! -f "$udp2raw_conf" ]]; then red "ä¸²è”å®ä¾‹ ${id} çš„é…ç½®æ–‡ä»¶ä¸å®Œæ•´ã€‚"; return; fi
    
    local ip=$(get_public_ip)
    local udp2raw_port=$(get_listen_info_from_conf "$udp2raw_conf" | awk -F':' '{print $NF}')
    local udp2raw_password=$(grep -Po '(?<=-k )[^ ]+' "$udp2raw_conf")
    local raw_mode=$(grep -Po '(?<=--raw-mode )[^ ]+' "$udp2raw_conf")
    local cipher_mode=$(grep -Po '(?<=--cipher-mode )[^ ]+' "$udp2raw_conf")
    local auth_mode=$(grep -Po '(?<=--auth-mode )[^ ]+' "$udp2raw_conf")
    
    local client_args="-c -r ${ip}:${udp2raw_port} -l ${client_listen_addr} -k ${udp2raw_password} --raw-mode ${raw_mode} --cipher-mode ${cipher_mode} --auth-mode ${auth_mode} --seq-mode 4 -a --keep-rule --fix-gro"
    local client_udp2raw_host="127.0.0.1" # å¼ºåˆ¶æœ¬åœ°å›ç¯
    local client_udp2raw_port=$(echo "$client_listen_addr" | cut -d: -f2)
    local sub_link=""
    local display_title=""
    local host_label=$ip

    if [[ "$chain_type" == "hy2" ]]; then
        display_title="[hy2+UDP2RAW]"
        local hy2_password=$(grep -Po '(?<=password: ).*' "$main_conf_path" | tr -d '[:space:]')
        
        # åŠ¨æ€æå– SNI
        local cert_path=$(grep -Po '(?<=cert: ).*' "$main_conf_path" | tr -d '[:space:]')
        local sni=""
        local insecure_flag=0
        
        if [[ "$cert_path" == *"$AX_CERT_DIR"* ]]; then
            # æ˜¯ ACME è¯ä¹¦
            sni=$(echo "$cert_path" | cut -d'/' -f4)
            insecure_flag=0
        else
            # è‡ªç­¾å
            sni="$HY2_SNI"
            insecure_flag=$HY2_CLIENT_INSECURE
        fi
        
        # å¦‚æœæœ‰çœŸå®åŸŸåï¼ŒUDP2RAW å’Œ é“¾æ¥å¤‡æ³¨éƒ½ä½¿ç”¨åŸŸå
        local server_addr=$ip
        if [[ "$sni" != "$HY2_SNI" && -n "$sni" ]]; then
            server_addr=$sni
            host_label=$sni
            # æ›´æ–° client_args ä½¿ç”¨åŸŸå
            client_args="${UDP2RAW_CLIENT_BASE_ARGS} -r ${server_addr}:${udp2raw_port} -l ${client_listen_addr} -k ${udp2raw_password}"
        fi
        
        # æ›´æ”¹äº†èŠ‚ç‚¹å¤‡æ³¨æ ¼å¼ï¼šChain_hy2_... +UDP2RAW
        sub_link="hysteria2://${hy2_password}@${client_udp2raw_host}:${client_udp2raw_port}?sni=${sni}&insecure=${insecure_flag}#Chain_hy2_${host_label}_${id}+UDP2RAW"
    else # vless
        display_title="[VLESS_mKCP+UDP2RAW]"
        local uuid=$(jq -r '.inbounds[0].settings.clients[0].id' "$main_conf_path")
        local seed=$(jq -r '.inbounds[0].streamSettings.kcpSettings.seed' "$main_conf_path")
        local header_type=$(jq -r '.inbounds[0].streamSettings.kcpSettings.header.type' "$main_conf_path")
        
        # æ›´æ”¹äº†èŠ‚ç‚¹å¤‡æ³¨æ ¼å¼ï¼šChain_vless_kcp_... +UDP2RAW
        sub_link="vless://${uuid}@${client_udp2raw_host}:${client_udp2raw_port}?type=kcp&security=none&headerType=${header_type}&seed=${seed}#Chain_vless_kcp_${host_label}_${id}+UDP2RAW"
    fi

    cyan "--- ${title} ä¸²è”å®ä¾‹ ${id} å®¢æˆ·ç«¯é…ç½® ---"; echo
    
    yellow "1. ${title} å®¢æˆ·ç«¯ (æŒ‡å‘æœ¬åœ°):"
    green "$sub_link"; echo
    
    yellow "2. UDP2RAW å®¢æˆ·ç«¯ (è¿æ¥å…¬ç½‘):"
    green "$client_args"; echo
    
    yellow "$display_title åˆå¹¶è®¢é˜…é“¾æ¥ (å¤åˆ¶ä»¥ä¸‹æ•´è¡Œ):"
    green "CHAIN##${sub_link} && UDP2RAW://${client_args}"
    echo
}

# å¯åŠ¨ä¸€ä¸ªæ–°çš„ 2 ç»„ä»¶ä¸²è”å®ä¾‹ (hy2 æˆ– vless)
start_new_chain_instance() {
    local chain_type=$1
    local i=1 id_prefix="" title="" main_conf_dir="" main_conf_template=""
    
    if [[ "$chain_type" == "hy2" ]]; then
        id_prefix="c"; title="Hysteria2+UDP"; main_conf_dir="$HY2_INSTALL_DIR"; main_conf_template="$HYSTERIA2_CONFIG_YAML_TEMPLATE"
        while true; do if [[ ! -f "$main_conf_dir/hy2_c${i}.yaml" ]]; then break; fi; i=$((i + 1)); done
    else # vless
        id_prefix="vc"; title="VLESS_mKCP+UDP"; main_conf_dir="$XRAY_INSTALL_DIR"; main_conf_template="$XRAY_VLESS_MKCP_TEMPLATE"
        while true; do if [[ ! -f "$main_conf_dir/xray_vc${i}.json" ]]; then break; fi; i=$((i + 1)); done
    fi
    
    local chain_id="${id_prefix}${i}"
    log "å¯åŠ¨ä¸€ä¸ªæ–°çš„ ${title} ä¸²è”å®ä¾‹ (å…¨è‡ªåŠ¨)..."
    green "æ–°ä¸²è”å®ä¾‹å°†è¢«åˆ›å»ºä¸º: ${chain_id}"
    
    local udp2raw_listen_port=$(find_available_port)
    local internal_listen_port=$(find_available_port)
    local udp2raw_password=$(generate_strong_password)
    
    local main_config="$main_conf_template"
    local main_conf_path=""
    declare -A replacements

    if [[ "$chain_type" == "hy2" ]]; then
        local hy2_password=$(generate_strong_password)
        
        # --- ACME è¯ä¹¦æ”¯æŒ ---
        local use_acme=$(read_input "æ˜¯å¦ä½¿ç”¨ ACME (Let's Encrypt) è¯ä¹¦? (å¦åˆ™å°†ä½¿ç”¨è‡ªç­¾åè¯ä¹¦) [Y/n]" "y")
        local cert_path="" key_path="" masquerade_url=""
        
        if [[ "$use_acme" == "y" || "$use_acme" == "Y" ]]; then
            local domain_name=$(read_input "è¯·è¾“å…¥æ‚¨çš„åŸŸå (DNS å¿…é¡»æŒ‡å‘æœ¬æœº)" "")
            if [[ -z "$domain_name" ]]; then red "åŸŸåä¸èƒ½ä¸ºç©ºï¼"; return 1; fi
            if ! ax_get_certificate "$domain_name"; then red "è¯ä¹¦ç”³è¯·å¤±è´¥ï¼"; return 1; fi
            
            cert_path="$AX_CERT_DIR/$domain_name/fullchain.cer"
            key_path="$AX_CERT_DIR/$domain_name/private.key"
            masquerade_url="https://$domain_name"
        else
            generate_self_signed_cert
            cert_path="$HY2_CERT_PATH"
            key_path="$HY2_KEY_PATH"
            masquerade_url="$HY2_MASQUERADE_URL"
        fi
        
        main_config="${main_config//__LISTEN__/127.0.0.1:${internal_listen_port}}"
        main_config="${main_config//__CERT_PATH__/${cert_path}}"
        main_config="${main_config//__KEY_PATH__/${key_path}}"
        main_config="${main_config//__PASSWORD__/${hy2_password}}"
        main_config="${main_config//__MASQUERADE_URL__/${masquerade_url}}"
        main_config="${main_config/__UDP_SNIFF_CONFIG__/udpPorts: all}"
        main_config="${main_config/__IGNORE_BW__/false}"
        main_conf_path="$main_conf_dir/hy2_${chain_id}.yaml"
        
        # WARP (Hy2)
        local enable_warp=$(read_input "æ˜¯å¦å¯ç”¨ WARP SOCKS5 åˆ†æµ [y/N]" "n")
        local warp_config_block=""
        if [[ "$enable_warp" == "y" || "$enable_warp" == "Y" ]]; then
            local warp_addr="$DEFAULT_WARP_SOCKS_ADDR"
            local warp_port=$(read_input "è¯·è¾“å…¥ WARP SOCKS5 ç«¯å£" "$DEFAULT_WARP_SOCKS_PORT")
            warp_config_block="${HYSTERIA2_WARP_OUTBOUND_ACL_BLOCK//__WARP_SOCKS5_ADDR__/${warp_addr}:${warp_port}}"
            green "å·²å¯ç”¨ WARP (åœ°å€: ${warp_addr}:${warp_port})"
        else
            warp_config_block=$HYSTERIA2_DIRECT_ACL_BLOCK
            yellow "å·²ç¦ç”¨ WARP"
        fi
        main_config=${main_config/__OUTBOUNDS_AND_ACL__/$warp_config_block}
        
        deploy_service_instance "ax-hysteria2@${chain_id}.service" "$main_conf_path" "$main_config" || return 1

    else # vless
        local uuid=$(generate_strong_password)
        local mkcp_seed=$(generate_strong_password)
        
        main_config=${main_config/__LISTEN_ADDR__/127.0.0.1}
        main_config=${main_config/__LISTEN_PORT__/$internal_listen_port}
        main_config=${main_config/__UUID__/$uuid}
        main_config=${main_config/__MKCP_SEED__/$mkcp_seed}
        
        # mKCP å‚æ•°äº¤äº’
        echo; cyan "--- é…ç½® mKCP ä¼ è¾“å‚æ•° ---"
        local mtu=$(read_input "è¯·è¾“å…¥ MTU [1350]" "1350"); main_config=${main_config/__MTU__/$mtu}
        local tti=$(read_input "è¯·è¾“å…¥ TTI [20]" "20"); main_config=${main_config/__TTI__/$tti}
        local uplink=$(read_input "ä¸Šè¡Œå®¹é‡ MB/s [5]" "5"); main_config=${main_config/__UPLINK__/$uplink}
        local downlink=$(read_input "ä¸‹è¡Œå®¹é‡ MB/s [20]" "20"); main_config=${main_config/__DOWNLINK__/$downlink}
        
        local congestion_choice=$(read_input_with_options "æ˜¯å¦å¯ç”¨æ‹¥å¡æ§åˆ¶?" "1" "æ˜¯ (true)" "å¦ (false)")
        if [[ "$congestion_choice" == "1" ]]; then main_config=${main_config/__CONGESTION__/true}; else main_config=${main_config/__CONGESTION__/false}; fi
        
        local read_buf=$(read_input "è¯»å–ç¼“å†²åŒº MB [2]" "2"); main_config=${main_config/__READ_BUF__/$read_buf}
        local write_buf=$(read_input "å†™å…¥ç¼“å†²åŒº MB [2]" "2"); main_config=${main_config/__WRITE_BUF__/$write_buf}
        
        local header_opts=("none" "srtp" "utp" "wechat-video" "dtls" "wireguard")
        local header_idx=$(read_input_with_options "ä¼ªè£…å¤´ç±»å‹:" "1" "${header_opts[@]}")
        main_config=${main_config/__HEADER_TYPE__/${header_opts[$((header_idx-1))]}}
        
        main_conf_path="$main_conf_dir/xray_${chain_id}.json"
        
        # WARP (VLESS)
        local enable_warp=$(read_input "æ˜¯å¦å¯ç”¨ WARP SOCKS5 åˆ†æµ [y/N]" "n")
        local warp_config_block=""
        if [[ "$enable_warp" == "y" || "$enable_warp" == "Y" ]]; then
            local warp_addr="$DEFAULT_WARP_SOCKS_ADDR"
            local warp_port=$(read_input "è¯·è¾“å…¥ WARP SOCKS5 ç«¯å£" "$DEFAULT_WARP_SOCKS_PORT")
            warp_config_block=$XRAY_WARP_OUTBOUND_AND_ROUTING_BLOCK
            warp_config_block=${warp_config_block/__WARP_SOCKS5_ADDR__/$warp_addr}
            warp_config_block=${warp_config_block/__WARP_SOCKS5_PORT__/$warp_port}
            green "å·²å¯ç”¨ WARP (åœ°å€: ${warp_addr}:${warp_port})"
        else
            warp_config_block=$XRAY_DIRECT_OUTBOUND_AND_ROUTING_BLOCK
            yellow "å·²ç¦ç”¨ WARP"
        fi
        main_config=${main_config/__OUTBOUNDS_AND_ROUTING__/$warp_config_block}
        
        deploy_service_instance "ax-xray@${chain_id}.service" "$main_conf_path" "$main_config" || return 1
    fi
    
    # UDP2RAW
    log "ç”Ÿæˆ UDP2RAW é…ç½®æ–‡ä»¶..."; local temp_udp_config="${UDP2RAW_CONFIG_TEMPLATE}"
    
    # UDP2RAW å‚æ•°äº¤äº’
    local raw_mode_opts=("faketcp" "udp" "icmp")
    local raw_mode_idx=$(read_input_with_options "è¯·é€‰æ‹© UDP2RAW raw-mode:" "1" "${raw_mode_opts[@]}")
    local raw_mode="${raw_mode_opts[$((raw_mode_idx-1))]}"
    
    local cipher_mode_opts=("aes128cbc" "xor" "none")
    local cipher_mode_idx=$(read_input_with_options "è¯·é€‰æ‹© UDP2RAW cipher-mode:" "1" "${cipher_mode_opts[@]}")
    local cipher_mode="${cipher_mode_opts[$((cipher_mode_idx-1))]}"
    
    local auth_mode_opts=("hmac_sha1" "md5" "crc32" "simple" "none")
    local auth_mode_idx=$(read_input_with_options "è¯·é€‰æ‹© UDP2RAW auth-mode:" "1" "${auth_mode_opts[@]}")
    local auth_mode="${auth_mode_opts[$((auth_mode_idx-1))]}"

    temp_udp_config="${temp_udp_config//__LISTEN_ADDR__/0.0.0.0:${udp2raw_listen_port}}"
    temp_udp_config="${temp_udp_config//__TARGET_ADDR__/127.0.0.1:${internal_listen_port}}"
    temp_udp_config="${temp_udp_config//__PASSWORD__/${udp2raw_password}}"
    temp_udp_config="${temp_udp_config//__RAW_MODE__/${raw_mode}}"
    temp_udp_config="${temp_udp_config//__CIPHER_MODE__/${cipher_mode}}"
    temp_udp_config="${temp_udp_config//__AUTH_MODE__/${auth_mode}}"
    
    deploy_service_instance "ax-udp2raw@${chain_id}.service" "$UDP2RAW_INSTALL_DIR/udp2raw_${chain_id}.conf" "$temp_udp_config" || return 1
    
    # æ±‡æ€»æ˜¾ç¤º
    echo
    cyan "=== è‡ªåŠ¨ç”Ÿæˆçš„é…ç½®å‚æ•° ==="
    green "å¯¹å¤–ç›‘å¬ç«¯å£ (UDP2RAW): $udp2raw_listen_port"
    green "å†…éƒ¨ç›‘å¬ç«¯å£: $internal_listen_port"
    green "UDP2RAW å¯†ç : $udp2raw_password"
    if [[ "$chain_type" == "hy2" ]]; then
        green "Hysteria2 å¯†ç : $hy2_password"
    else
        green "VLESS UUID: $uuid"
        green "mKCP Seed: $mkcp_seed"
    fi
    echo

    sleep 1; green "ä¸²è”å®ä¾‹ ${chain_id} å·²å¯åŠ¨ï¼"; echo
    view_chain_client_config "$chain_type" "$i"
}

# ç®¡ç†ä¸€ä¸ªå·²å­˜åœ¨çš„ 2 ç»„ä»¶ä¸²è”å®ä¾‹
manage_chain_instance() {
    local chain_type=$1 id_num=$2
    local id_prefix="" title="" service1_name="" service2_name="" main_conf_path=""
    
    if [[ "$chain_type" == "hy2" ]]; then
        id_prefix="c"; title="Hysteria2"; service1_name="ax-hysteria2"; main_conf_path="$HY2_INSTALL_DIR/hy2_c${id_num}.yaml"
    else # vless
        id_prefix="vc"; title="VLESS_mKCP"; service1_name="ax-xray"; main_conf_path="$XRAY_INSTALL_DIR/xray_vc${id_num}.json"
    fi
    
    local manage_id="${id_prefix}${id_num}"
    service2_name="ax-udp2raw"
    local service1_full="${service1_name}@${manage_id}.service"
    local service2_full="${service2_name}@${manage_id}.service"
    local udp2raw_conf_path="$UDP2RAW_INSTALL_DIR/udp2raw_${manage_id}.conf"
    
    while true; do
        clear; echo "=================================="; echo "      ç®¡ç†${title}ä¸²è”å®ä¾‹ $(dim "${manage_id}")"; echo "=================================="
        read -r color s1_status s2_status <<< "$(check_services_status "$service1_full" "$service2_full")"
        local udp2raw_info=$(get_listen_info_from_conf "$udp2raw_conf_path")
        
        if [[ "$chain_type" == "hy2" ]]; then
            $color "çŠ¶æ€: Hysteria2 [${s1_status}] + UDP2RAW [${s2_status}] $(dim "$udp2raw_info")"
        else
            $color "çŠ¶æ€: VLESS_mKCP [${s1_status}] + UDP2RAW [${s2_status}] $(dim "$udp2raw_info")"
        fi

        echo "----------------------------------"; echo "1) å¯åŠ¨/é‡å¯æ­¤ä¸²è”"; echo "2) åœæ­¢æ­¤ä¸²è”"; echo "3) æŸ¥çœ‹å®¢æˆ·ç«¯é…ç½®æŒ‡å—"; echo "4) æŸ¥çœ‹ ${title} æ—¥å¿—"; echo "5) æŸ¥çœ‹ UDP2RAW æ—¥å¿—"; echo "6) ç¼–è¾‘ ${title} é…ç½®æ–‡ä»¶ (é«˜çº§)"; echo "7) ç¼–è¾‘ UDP2RAW é…ç½®æ–‡ä»¶ (é«˜çº§)"; echo "99) å½»åº•åˆ é™¤æ­¤ä¸²è”"; echo "0) è¿”å›"
        read -p "è¯·é€‰æ‹©: " manage_choice
        case $manage_choice in
            1) log "é‡å¯ä¸²è”..."; systemctl restart "$service1_full" "$service2_full";;
            2) log "åœæ­¢ä¸²è”..."; systemctl stop "$service1_full" "$service2_full";;
            3) view_chain_client_config "$chain_type" "$id_num"; read -p $'\næŒ‰ä»»æ„é”®è¿”å›...' -n1 -s;;
            4) 
                # ä¿®å¤ Ctrl+C é—®é¢˜
                log "æ­£åœ¨å®æ—¶è·Ÿè¸ª ${title} æ—¥å¿—... (æŒ‰ Ctrl+C ä»…é€€å‡ºæ—¥å¿—)"
                local current_trap=$(trap -p SIGINT)
                trap ':' SIGINT
                journalctl -u "$service1_full" -f
                eval "$current_trap"
                ;;
            5) 
                # ä¿®å¤ Ctrl+C é—®é¢˜
                log "æ­£åœ¨å®æ—¶è·Ÿè¸ª UDP2RAW æ—¥å¿—... (æŒ‰ Ctrl+C ä»…é€€å‡ºæ—¥å¿—)"
                local current_trap=$(trap -p SIGINT)
                trap ':' SIGINT
                journalctl -u "$service2_full" -f
                eval "$current_trap"
                ;;
            6) nano "$main_conf_path"; systemctl restart "$service1_full";;
            7) nano "$udp2raw_conf_path"; systemctl restart "$service2_full";;
            99) read -p "ç¡®è®¤åˆ é™¤ä¸²è”å®ä¾‹ ${manage_id}ï¼Ÿ(é»˜è®¤â€œå¦â€) [y/N]: " del_confirm; if [[ "$del_confirm" == "y" ]]; then 
                log "åˆ é™¤ä¸²è”..."; 
                systemctl stop "$service1_full" "$service2_full"; 
                systemctl disable "$service1_full" "$service2_full" >/dev/null 2>&1; 
                rm -f "$main_conf_path" "$udp2raw_conf_path"; 
                systemctl daemon-reload; green "å·²åˆ é™¤ã€‚"; break; 
                fi;;
            0) break;; *) red "æ— æ•ˆè¾“å…¥";;
        esac
        [[ "$manage_choice" == "1" || "$manage_choice" == "2" || "$manage_choice" == "6" || "$manage_choice" == "7" ]] && read -p $'\næŒ‰ä»»æ„é”®è¿”å›...' -n1 -s
    done
}

# 3 ç»„ä»¶ä¸²è”å®ä¾‹çš„é€šç”¨ç®¡ç†èœå•
chain_manager_menu_3() {
    local title="SS+KCP+UDP ä¸€é”®ä¸²è”"
    
    while true; do
        trap 'echo -e \"\n\n${yellow}æ“ä½œå·²å–æ¶ˆï¼Œè„šæœ¬å®‰å…¨é€€å‡ºã€‚${reset}\"; exit 1' SIGINT
        clear; echo "=================================="; echo "  å®‰è£…/ç®¡ç† $title"; echo "=================================="; echo
        
        local INSTANCES=$(get_chain_instances_3)
        if [[ -n "$INSTANCES" ]]; then 
            echo "$(bold "--- å·²å­˜åœ¨çš„ä¸²è”å®ä¾‹ ---")"
            for i in $INSTANCES; do 
                display_instance_status_line "ss_3_chain_chain" "$i" "  "
            done
        else 
            yellow "å½“å‰æ²¡æœ‰å·²åˆ›å»ºçš„ä¸²è”å®ä¾‹ã€‚"
        fi
        
        echo "----------------------------------"; echo "1) å¯åŠ¨ä¸€ä¸ªæ–°çš„ä¸²è”å®ä¾‹"; echo "2) ç®¡ç†ä¸€ä¸ªå·²å­˜åœ¨çš„ä¸²è”å®ä¾‹"; echo "3) æŸ¥çœ‹é…ç½®"; echo "0) è¿”å›ä¸»èœå•"
        read -p "è¯·é€‰æ‹©: " choice
        case $choice in
            1) start_new_chain_instance_3; read -p $'\næŒ‰ä»»æ„é”®è¿”å›...' -n1 -s;;
            2) 
                if [[ -z "$INSTANCES" ]]; then yellow "å½“å‰æ²¡æœ‰å¯ç®¡ç†çš„å®ä¾‹ã€‚"; sleep 2; continue; fi
                read -p "è¯·è¾“å…¥æ‚¨æƒ³ç®¡ç†çš„ä¸²è”å®ä¾‹ID (ä»…æ•°å­—) [$(echo $INSTANCES | tr '\n' ' ')]: " manage_id_num
                # ç®€å•çš„å­˜åœ¨æ€§æ£€æŸ¥
                if echo "$INSTANCES" | grep -w -q "$manage_id_num"; then 
                    manage_chain_instance_3 "$manage_id_num"
                else 
                    red "æ— æ•ˆçš„å®ä¾‹IDï¼"; sleep 2
                fi
                ;;
            3) 
                if [[ -z "$INSTANCES" ]]; then yellow "å½“å‰æ²¡æœ‰å®ä¾‹å¯ä¾›æŸ¥çœ‹ã€‚"; sleep 2; continue; fi
                local i; for i in $INSTANCES; do view_chain_client_config_3 "$i"; done
                read -p $'\næŒ‰ä»»æ„é”®è¿”å›...' -n1 -s
                ;;
            0) break;; *) red "æ— æ•ˆè¾“å…¥"; sleep 1;;
        esac
    done; trap - SIGINT
}

# 2 ç»„ä»¶ä¸²è”å®ä¾‹çš„é€šç”¨ç®¡ç†èœå•
chain_manager_menu() {
    local chain_type=$1
    local title=""
    if [[ "$chain_type" == "hy2" ]]; then
        title="Hysteria2+UDPä¸€é”®ä¸²è”"
    else # vless
        title="VLESS_mKCP+UDPä¸€é”®ä¸²è”"
    fi
    
    while true; do
        trap 'echo -e \"\n\n${yellow}æ“ä½œå·²å–æ¶ˆï¼Œè„šæœ¬å®‰å…¨é€€å‡ºã€‚${reset}\"; exit 1' SIGINT
        clear; echo "=================================="; echo "  å®‰è£…/ç®¡ç† $title"; echo "=================================="; echo
        
        local INSTANCES=$(get_chain_instances "$chain_type")
        if [[ -n "$INSTANCES" ]]; then 
            echo "$(bold "--- å·²å­˜åœ¨çš„ä¸²è”å®ä¾‹ ---")"
            for i in $INSTANCES; do 
                display_instance_status_line "${chain_type}_chain" "$i" "  "
            done
        else 
            yellow "å½“å‰æ²¡æœ‰å·²åˆ›å»ºçš„ä¸²è”å®ä¾‹ã€‚"
        fi
        
        echo "----------------------------------"; echo "1) å¯åŠ¨ä¸€ä¸ªæ–°çš„ä¸²è”å®ä¾‹"; echo "2) ç®¡ç†ä¸€ä¸ªå·²å­˜åœ¨çš„ä¸²è”å®ä¾‹"; echo "3) æŸ¥çœ‹é…ç½®"; echo "0) è¿”å›ä¸»èœå•"
        read -p "è¯·é€‰æ‹©: " choice
        case $choice in
            1) start_new_chain_instance "$chain_type"; read -p $'\næŒ‰ä»»æ„é”®è¿”å›...' -n1 -s;;
            2) if [[ -z "$INSTANCES" ]]; then yellow "å½“å‰æ²¡æœ‰å¯ç®¡ç†çš„å®ä¾‹ã€‚"; sleep 2; continue; fi; read -p "è¯·è¾“å…¥æ‚¨æƒ³ç®¡ç†çš„ä¸²è”å®ä¾‹ID (ä»…æ•°å­—) [$(echo $INSTANCES | tr '\n' ' ')]: " manage_id_num; if echo "$INSTANCES" | grep -w -q "$manage_id_num"; then manage_chain_instance "$chain_type" "$manage_id_num"; else red "æ— æ•ˆçš„å®ä¾‹IDï¼"; sleep 2; fi;;
            3) if [[ -z "$INSTANCES" ]]; then yellow "å½“å‰æ²¡æœ‰å®ä¾‹å¯ä¾›æŸ¥çœ‹ã€‚"; sleep 2; continue; fi; local i; for i in $INSTANCES; do view_chain_client_config "$chain_type" $i; done; read -p $'\næŒ‰ä»»æ„é”®è¿”å›...' -n1 -s;;
            0) break;; *) red "æ— æ•ˆè¾“å…¥"; sleep 1;;
        esac
    done; trap - SIGINT
}

# ç‹¬ç«‹å®ä¾‹æ€»ç®¡ç†èœå• (å¾ªç¯)
main_manager_loop() {
    local type=$1; local title dir pattern service_prefix type_lowercase
    case $type in 
        hysteria2) title="Hysteria2 (ç‹¬ç«‹)"; dir="$HY2_INSTALL_DIR"; pattern="hy2_*.yaml"; service_prefix="ax-hysteria2"; type_lowercase="hysteria2";;
        udp2raw) title="UDP2RAW (ç‹¬ç«‹)"; dir="$UDP2RAW_INSTALL_DIR"; pattern="udp2raw_*.conf"; service_prefix="ax-udp2raw"; type_lowercase="udp2raw";;
        kcptun) title="KCPTUN (ç‹¬ç«‹)"; dir="$KCPTUN_INSTALL_DIR"; pattern="kcptun_*.json"; service_prefix="ax-kcptun"; type_lowercase="kcptun";;
        xray_reality) title="VLESS+Reality (ç‹¬ç«‹)"; dir="$XRAY_INSTALL_DIR"; pattern="xray_*.json"; service_prefix="ax-xray"; type_lowercase="xray_reality";;
        xray_mkcp) title="VLESS+mKCP (ç‹¬ç«‹)"; dir="$XRAY_INSTALL_DIR"; pattern="xray_*.json"; service_prefix="ax-xray"; type_lowercase="xray_mkcp";;
        xray_ss) title="Shadowsocks (ç‹¬ç«‹)"; dir="$XRAY_INSTALL_DIR"; pattern="xray_*.json"; service_prefix="ax-xray"; type_lowercase="xray_ss";;
    esac
    while true; do
        trap 'echo -e \"\n\n${yellow}æ“ä½œå·²å–æ¶ˆï¼Œè„šæœ¬å®‰å…¨é€€å‡ºã€‚${reset}\"; exit 1' SIGINT
        clear; echo "=================================="; echo "     å®‰è£…/ç®¡ç† $title"; echo "=================================="; echo
        
        local INSTANCES=($(get_standalone_instances "$type_lowercase"))

        if [[ ${#INSTANCES[@]} -gt 0 ]]; then
            echo "$(bold "--- å·²å­˜åœ¨çš„å®ä¾‹ ---")"; for i in "${INSTANCES[@]}"; do display_instance_status_line "$type_lowercase" "$i" "  "; done
        else
            yellow "å½“å‰æ²¡æœ‰å·²åˆ›å»ºçš„ $title å®ä¾‹ã€‚"
        fi

        echo "----------------------------------"; local menu_options=("1) å¯åŠ¨ä¸€ä¸ªæ–°çš„å®ä¾‹" "2) ç®¡ç†ä¸€ä¸ªå·²å­˜åœ¨çš„å®ä¾‹")
        if [[ "$type" == "hysteria2" ]]; then menu_options+=("3) æŸ¥çœ‹hy2è®¢é˜…åœ°å€");
        elif [[ "$type" == "xray_reality" || "$type" == "xray_mkcp" || "$type" == "xray_ss" ]]; then menu_options+=("3) æŸ¥çœ‹åˆ†äº«é“¾æ¥");
        elif [[ "$type" == "udp2raw" || "$type" == "kcptun" ]]; then menu_options+=("3) æŸ¥çœ‹å®¢æˆ·ç«¯é…ç½®"); fi
        menu_options+=("0) è¿”å›ä¸»èœå•"); for opt in "${menu_options[@]}"; do echo "$opt"; done
        read -p "è¯·é€‰æ‹©: " choice
        case $choice in
            1)
                if [[ "$type" == "xray_reality" || "$type" == "xray_mkcp" || "$type" == "xray_ss" ]]; then create_new_xray_instance "$type_lowercase"; else create_new_instance "$type_lowercase"; fi
                read -p $'\næŒ‰ä»»æ„é”®è¿”å›...' -n1 -s;;
            2)
                if [[ ${#INSTANCES[@]} -eq 0 ]]; then yellow "å½“å‰æ²¡æœ‰å¯ç®¡ç†çš„å®ä¾‹ã€‚"; sleep 2; continue; fi
                local manage_id; read -p "è¯·è¾“å…¥æ‚¨æƒ³ç®¡ç†çš„å®ä¾‹ID [$(echo "${INSTANCES[@]}")]: " manage_id; local is_valid=false; for id in "${INSTANCES[@]}"; do if [[ "$id" == "$manage_id" ]]; then is_valid=true; break; fi; done
                if [[ "$is_valid" == true ]]; then
                    local conf_path
                    case $type in
                        hysteria2) conf_path="$dir/hy2_${manage_id}.yaml";;
                        udp2raw) conf_path="$dir/udp2raw_${manage_id}.conf";;
                        kcptun) conf_path="$dir/kcptun_${manage_id}.json";;
                        xray_reality|xray_mkcp|xray_ss) conf_path="$dir/xray_${manage_id}.json";;
                    esac
                    manage_instance_menu "$type_lowercase" "$manage_id" "${service_prefix}@${manage_id}" "$conf_path"
                else red "æ— æ•ˆçš„å®ä¾‹IDï¼"; sleep 2; fi;;
            3)
                if [[ ${#INSTANCES[@]} -eq 0 ]]; then yellow "å½“å‰æ²¡æœ‰å®ä¾‹å¯ä¾›æŸ¥çœ‹ã€‚"; sleep 2; continue; fi
                if [[ "$type" == "hysteria2" ]]; then view_all_hy2_subscriptions
                else
                    local view_id; read -p "è¯·è¾“å…¥æ‚¨æƒ³æŸ¥çœ‹çš„å®ä¾‹ID [$(echo "${INSTANCES[@]}")]: " view_id; local is_valid=false; for id in "${INSTANCES[@]}"; do if [[ "$id" == "$view_id" ]]; then is_valid=true; break; fi; done
                    if [[ "$is_valid" == true ]]; then
                        case "$type" in
                            udp2raw) view_udp2raw_client_config "$view_id" ;;
                            kcptun) view_kcptun_client_config "$view_id" ;;
                            xray_reality) cyan "$(generate_xray_reality_link "$view_id")" ;;
                            xray_mkcp) cyan "$(generate_xray_mkcp_link "$view_id")" ;;
                            xray_ss) cyan "$(generate_xray_ss_link "$view_id")" ;;
                        esac
                    else red "æ— æ•ˆçš„å®ä¾‹IDï¼"; fi
                fi
                read -p $'\næŒ‰ä»»æ„é”®è¿”å›...' -n1 -s;;
            0) break;; *) red "æ— æ•ˆè¾“å…¥"; sleep 1;;
        esac
    done; trap - SIGINT
}

# --- 17. å…¨å±€æ“ä½œ (æŸ¥çœ‹å…¨éƒ¨/é‡å¯/æ›´æ–°/å¸è½½) ---

# æ˜¾ç¤ºå…¨å±€ TLS è¯ä¹¦çŠ¶æ€
show_global_tls_status() {
    echo "--- TLS è¯ä¹¦çŠ¶æ€ ---"
    
    # æ£€æŸ¥ ACME è¯ä¹¦ç›®å½•
    if [ ! -d "$AX_CERT_DIR" ] || [ -z "$(ls -A $AX_CERT_DIR)" ]; then
        yellow "  æœªæ‰¾åˆ° ACME è¯ä¹¦ã€‚"
    else
        # éå† $AX_CERT_DIR ä¸‹çš„æ¯ä¸ªåŸŸåç›®å½•
        for domain_dir in "$AX_CERT_DIR"/*; do
            if [ -d "$domain_dir" ]; then
                local domain=$(basename "$domain_dir")
                local cert_file="$domain_dir/fullchain.cer"
                local key_file="$domain_dir/private.key"
                
                if [ -f "$cert_file" ] && [ -f "$key_file" ]; then
                    local expiry_date_str
                    local days_remaining="N/A"
                    
                    # å°è¯•è·å–åˆ°æœŸå¤©æ•°
                    if command -v openssl &>/dev/null; then
                        expiry_date_str=$(openssl x509 -in "$cert_file" -noout -enddate 2>/dev/null | cut -d= -f2)
                        if [ -n "$expiry_date_str" ]; then
                            local expiry_epoch=$(date -d "$expiry_date_str" +%s 2>/dev/null)
                            local now_epoch=$(date +%s)
                            if [ -n "$expiry_epoch" ]; then
                                days_remaining=$(((expiry_epoch - now_epoch) / 86400))
                                days_remaining="(å‰©ä½™ ${days_remaining} å¤©)"
                            fi
                        fi
                    fi
                    
                    cyan "[åŸŸå] $domain $days_remaining"
                    echo "  å…¬é’¥ (Cert): $cert_file"
                    echo "  ç§é’¥ (Key):  $key_file"
                fi
            fi
        done
    fi
}

# æŸ¥çœ‹å…¨éƒ¨å®ä¾‹çš„å®¢æˆ·ç«¯é…ç½®
view_all_configs() {
    clear; echo "=================================="; echo "        æŸ¥çœ‹å…¨éƒ¨å®ä¾‹é…ç½®"; echo "=================================="; echo
    
    local ss_3_chain_instances=$(get_chain_instances_3); if [[ -n "$ss_3_chain_instances" ]]; then for i in $ss_3_chain_instances; do view_chain_client_config_3 "$i"; echo "----------------------------------"; done; fi
    local hy2_chain_instances=$(get_chain_instances "hy2"); if [[ -n "$hy2_chain_instances" ]]; then for i in $hy2_chain_instances; do view_chain_client_config "hy2" "$i"; echo "----------------------------------"; done; fi
    local vless_chain_instances=$(get_chain_instances "vless"); if [[ -n "$vless_chain_instances" ]]; then for i in $vless_chain_instances; do echo; view_chain_client_config "vless" "$i"; echo "----------------------------------"; done; fi
    
    local standalone_hy2=($(get_standalone_instances "hysteria2")); if [[ ${#standalone_hy2[@]} -gt 0 ]]; then echo; cyan "--- Hysteria2 (ç‹¬ç«‹) å®ä¾‹è®¢é˜…é“¾æ¥ ---"; echo 
    for id in "${standalone_hy2[@]}"; do green "$(generate_hy2_subscription_link $id)"; done; echo "----------------------------------"; fi
    
    local standalone_reality=($(get_standalone_instances "xray_reality")); if [[ ${#standalone_reality[@]} -gt 0 ]]; then echo; cyan "--- VLESS+Reality (ç‹¬ç«‹) å®ä¾‹è®¢é˜…é“¾æ¥ ---"; echo 
    for id in "${standalone_reality[@]}"; do green "$(generate_xray_reality_link $id)"; done; echo "----------------------------------"; fi
    local standalone_mkcp=($(get_standalone_instances "xray_mkcp")); if [[ ${#standalone_mkcp[@]} -gt 0 ]]; then echo; cyan "--- VLESS+mKCP (ç‹¬ç«‹) å®ä¾‹è®¢é˜…é“¾æ¥ ---"; echo 
    for id in "${standalone_mkcp[@]}"; do green "$(generate_xray_mkcp_link $id)"; done; echo "----------------------------------"; fi
    local standalone_ss=($(get_standalone_instances "xray_ss")); if [[ ${#standalone_ss[@]} -gt 0 ]]; then echo; cyan "--- Shadowsocks (ç‹¬ç«‹) å®ä¾‹è®¢é˜…é“¾æ¥ ---"; echo
    for id in "${standalone_ss[@]}"; do green "$(generate_xray_ss_link $id)"; done; echo "----------------------------------"; fi
    
    local standalone_udp2raw=($(get_standalone_instances "udp2raw")); if [[ ${#standalone_udp2raw[@]} -gt 0 ]]; then echo; for id in "${standalone_udp2raw[@]}"; do view_udp2raw_client_config "$id"; echo; done; echo "----------------------------------"; fi
    local standalone_kcptun=($(get_standalone_instances "kcptun")); if [[ ${#standalone_kcptun[@]} -gt 0 ]]; then echo; for id in "${standalone_kcptun[@]}"; do view_kcptun_client_config "$id"; echo; done; fi

    if ! is_installed; then yellow "ç³»ç»Ÿä¸­æ²¡æœ‰ä»»ä½•å·²é…ç½®çš„å®ä¾‹ã€‚"; fi
}

# é‡å¯æ‰€æœ‰æœåŠ¡
restart_all_services(){ log "æ­£åœ¨é‡å¯æ‰€æœ‰æ­£åœ¨è¿è¡Œçš„å®ä¾‹..."; systemctl restart ax-kcptun@*.service ax-udp2raw@*.service hysteria2@*.service ax-xray@*.service 2>/dev/null; green "æ“ä½œå®Œæˆï¼"; sleep 2; }

# æ£€æŸ¥å¹¶æ›´æ–°æ‰€æœ‰æ ¸å¿ƒç¨‹åº
check_for_updates(){ log "æ£€æŸ¥æ›´æ–°..."; download_kcp_udp_binaries; download_hysteria2_binary; download_xray_binary; log "æ‰€æœ‰ç¨‹åºå·²æ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬ï¼Œé‡å¯æ‰€æœ‰æœåŠ¡ä»¥åº”ç”¨..."; restart_all_services; sleep 2;}

# å®‰è£… VPS ä¸€é”®ä¼˜åŒ–è„šæœ¬
install_sys_opt() {
    echo "----------------------------------------------------------------"
    log "è¿è¡Œ VPS ä¸€é”®ä¼˜åŒ–è„šæœ¬ (æœ¬åœ°æ¨¡å¼)..."
    
    # ç¡®ä¿æœ¬åœ°æœ‰æ–‡ä»¶ï¼Œæ²¡æœ‰åˆ™è¡¥æ•‘ä¸‹è½½
    if [ ! -f "$AX_TOOLS_DIR/vps_optimizert.sh" ]; then
        download_aux_tools
    fi
    
    if [ -f "$AX_TOOLS_DIR/vps_optimizert.sh" ]; then
         bash "$AX_TOOLS_DIR/vps_optimizert.sh"
         echo "----------------------------------------------------------------"
         green "ä¼˜åŒ–è„šæœ¬æ‰§è¡Œå®Œæ¯•ã€‚"
    else
         red "é”™è¯¯ï¼šæ— æ³•æ‰¾åˆ°ä¼˜åŒ–è„šæœ¬æ–‡ä»¶ã€‚"
    fi
    log "å³å°†è¿”å›ä¸»èœå•..."
}

# å®‰è£… warp-socket5 è„šæœ¬
install_warp_yg() {
    echo "----------------------------------------------------------------"
    log "è¿è¡Œ WARP Socket5 è„šæœ¬ (æœ¬åœ°æ¨¡å¼)..."
    
    if [ ! -f "$AX_TOOLS_DIR/warp-socket5.sh" ]; then
        download_aux_tools
    fi
    
    if [ -f "$AX_TOOLS_DIR/warp-socket5.sh" ]; then
         bash "$AX_TOOLS_DIR/warp-socket5.sh"
         echo "----------------------------------------------------------------"
         green "WARP è„šæœ¬æ‰§è¡Œå®Œæ¯•ã€‚"
    else
         red "é”™è¯¯ï¼šæ— æ³•æ‰¾åˆ° WARP è„šæœ¬æ–‡ä»¶ã€‚"
    fi
    log "å³å°†è¿”å›ä¸»èœå•..."
}


# å¸è½½æ‰€æœ‰ (REFACTORED: ä¿®å¤è½¯å¸è½½è·¯å¾„)

# ACME è¯ä¹¦ç®¡ç†èœå•
acme_manager_menu() {
    while true; do
        clear; echo "=================================="; echo "      ACME è¯ä¹¦ç®¡ç†"; echo "=================================="
        show_global_tls_status
        echo "----------------------------------"
        echo " 1) ç”³è¯·æ–°è¯ä¹¦ (æ”¯æŒ Cloudflare/Aliyun/DNSPod)"
        echo " 2) æ‰‹åŠ¨å¼ºåˆ¶ç»­æœŸæ‰€æœ‰è¯ä¹¦"
        echo " 3) æŸ¥çœ‹ acme.sh å®šæ—¶ä»»åŠ¡"
        echo " 4) å‡çº§ acme.sh æ ¸å¿ƒ"
        echo " 0) è¿”å›ä¸»èœå•"
        read -p "è¯·é€‰æ‹©: " choice
        case $choice in
            1) 
                local domain=$(read_input "è¯·è¾“å…¥è¦ç”³è¯·è¯ä¹¦çš„åŸŸå" "")
                if [[ -n "$domain" ]]; then ax_get_certificate "$domain"; fi
                read -p $'\næŒ‰ä»»æ„é”®è¿”å›...' -n1 -s
                ;;
            2)
                log "æ­£åœ¨å¼ºåˆ¶ç»­æœŸæ‰€æœ‰è¯ä¹¦..."
                "$ACME_SH_INSTALL_DIR" --cron --force
                green "æ“ä½œå®Œæˆã€‚"
                read -p $'\næŒ‰ä»»æ„é”®è¿”å›...' -n1 -s
                ;;
            3)
                log "å½“å‰ç³»ç»Ÿçš„ Cron ä»»åŠ¡:"
                crontab -l | grep acme.sh
                read -p $'\næŒ‰ä»»æ„é”®è¿”å›...' -n1 -s
                ;;
            4)
                "$ACME_SH_INSTALL_DIR" --upgrade
                read -p $'\næŒ‰ä»»æ„é”®è¿”å›...' -n1 -s
                ;;
            0) break ;;
            *) red "æ— æ•ˆè¾“å…¥"; sleep 1 ;;
        esac
    done
}

uninstall_all() {
    clear
    echo "=================================="
    echo "        å½»åº•å¸è½½å‘å¯¼"
    echo "=================================="
    yellow "è­¦å‘Šï¼šæ­¤æ“ä½œå°†åœæ­¢å¹¶åˆ é™¤è„šæœ¬å®‰è£…çš„æ‰€æœ‰éš§é“æœåŠ¡ã€‚"
    
    read -p "ç¡®è®¤è¦ç»§ç»­å—ï¼Ÿ[y/N]: " confirm
    if [[ "$confirm" != "y" && "$confirm" != "Y" ]]; then 
        echo "å·²å–æ¶ˆã€‚"
        return 0
    fi
    
    # --- é€‰é¡¹æ£€æµ‹ ---
    
    # [AUTO] è‡ªåŠ¨æ£€æµ‹ WARP å¹¶æ ‡è®°å¸è½½ï¼Œä¸å†è¯¢é—®
    local remove_warp="n"
    if systemctl list-units --full -all | grep -q "warp-svc.service"; then
        # echo
        # yellow "æ£€æµ‹åˆ° Cloudflare WARP æœåŠ¡ (warp-svc) æ­£åœ¨è¿è¡Œï¼Œå°†è‡ªåŠ¨å¸è½½ã€‚"
        remove_warp="y"
    fi
    
    local remove_acme="n"
    if [[ -d "/root/.acme.sh" ]]; then
        echo
        yellow "æ£€æµ‹åˆ° acme.sh è¯ä¹¦å·¥å…·ã€‚"
        read -p "æ˜¯å¦è¿åŒ acme.sh åŠå…¶æ‰€æœ‰è¯ä¹¦æ•°æ®ä¸€èµ·å¸è½½ï¼Ÿ[y/N]: " remove_acme
    fi
    
    echo
    read -p "æ˜¯å¦åˆ é™¤æ‰€æœ‰é…ç½®æ–‡ä»¶ã€è¯ä¹¦å’Œæ—¥å¿— (å½»åº•æ¸…ç†)ï¼Ÿ[y/N]: " deep_clean

    # --- å¼€å§‹æ‰§è¡Œ ---
    echo
    log "æ­£åœ¨åœæ­¢ç›¸å…³æœåŠ¡..."
    
    # 1. åœæ­¢æ ¸å¿ƒä¸šåŠ¡æœåŠ¡
    local services=("ax-kcptun@*" "ax-udp2raw@*" "ax-hysteria2@*" "ax-xray@*" "hysteria-server@*")
    systemctl stop "${services[@]}" 2>/dev/null
    systemctl disable "${services[@]}" 2>/dev/null
    
    # 2. å¸è½½ WARP (å¦‚æœé€‰ä¸­)
    if [[ "$remove_warp" == "y" || "$remove_warp" == "Y" ]]; then
        log "æ­£åœ¨å¸è½½ Cloudflare WARP..."
        systemctl stop warp-svc 2>/dev/null
        systemctl disable warp-svc 2>/dev/null
        
        if command -v apt-get &>/dev/null; then
            apt-get remove -y cloudflare-warp --purge
        elif command -v yum &>/dev/null; then
            yum remove -y cloudflare-warp
        elif command -v dnf &>/dev/null; then
            dnf remove -y cloudflare-warp
        fi
        
        # æ¸…ç† WARP æ•°æ®
        rm -rf /var/lib/cloudflare-warp
        rm -rf /etc/warp-svc
        green "WARP å·²å¸è½½ã€‚"
    fi

    # 3. åˆ é™¤ Systemd å•å…ƒæ–‡ä»¶
    log "åˆ é™¤æœåŠ¡æ³¨å†Œæ–‡ä»¶..."
    rm -f /etc/systemd/system/ax-kcptun@.service \
          /etc/systemd/system/ax-udp2raw@.service \
          /etc/systemd/system/ax-hysteria2@.service \
          /etc/systemd/system/ax-xray@.service \
          /etc/systemd/system/hysteria-server@.service
    
    # 4. åˆ é™¤æ–‡ä»¶èµ„æº
    if [[ "$deep_clean" == "y" || "$deep_clean" == "Y" ]]; then
        log "æ­£åœ¨æ¸…é™¤æ‰€æœ‰é…ç½®ä¸æ•°æ®..."
        rm -rf "$KCPTUN_INSTALL_DIR" "$UDP2RAW_INSTALL_DIR" "$HY2_INSTALL_DIR" "$XRAY_INSTALL_DIR" "$AX_CERT_DIR"
        
        # åˆ é™¤é»˜è®¤ä½ç½®çš„è‡ªç­¾åè¯ä¹¦
        rm -f /etc/ssl/private/bing.com.crt /etc/ssl/private/bing.com.key
        # åˆ é™¤æ®‹ç•™è„šæœ¬ (å¦‚æœå­˜åœ¨æœ¬åœ°ç¼“å­˜)
        if [[ -n "$AX_TOOLS_DIR" ]]; then rm -rf "$AX_TOOLS_DIR"; fi
        rm -f warp-socket5.sh vps_optimizert.sh
        
        green "é…ç½®æ–‡ä»¶å·²å½»åº•åˆ é™¤ã€‚"
    else
        log "æ­£åœ¨åˆ é™¤äºŒè¿›åˆ¶ç¨‹åº (ä¿ç•™é…ç½®)..."
        rm -f "$KCPTUN_INSTALL_DIR/kcptun_server" \
              "$UDP2RAW_INSTALL_DIR/udp2raw" \
              "$HY2_INSTALL_DIR/hysteria" \
              "$XRAY_INSTALL_DIR/xray"
        
        # æ¸…ç† geo dat æ–‡ä»¶
        rm -f "$HY2_INSTALL_DIR/geoip.dat" "$HY2_INSTALL_DIR/geosite.dat"
        rm -f "$XRAY_INSTALL_DIR/geoip.dat" "$XRAY_INSTALL_DIR/geosite.dat"
    fi
    
    # 5. å¸è½½ acme.sh (å¦‚æœé€‰ä¸­)
    if [[ "$remove_acme" == "y" || "$remove_acme" == "Y" ]]; then
        log "æ­£åœ¨å¸è½½ acme.sh..."
        if [[ -f "$ACME_SH_INSTALL_DIR" ]]; then
            "$ACME_SH_INSTALL_DIR" --uninstall --nocolor >/dev/null 2>&1
        fi
        rm -rf "/root/.acme.sh"
        green "acme.sh å·²å¸è½½ã€‚"
    fi

    # 6. æ¸…ç†ç³»ç»Ÿæ®‹ç•™
    log "æ¸…ç†ä¸´æ—¶æ–‡ä»¶ä¸é‡è½½ç³»ç»ŸæœåŠ¡..."
    rm -f /usr/local/bin/hysteria /usr/local/bin/xray
    rm -f /tmp/kcptun.tar.gz /tmp/udp2raw.tar.gz /tmp/xray.zip
    
    systemctl daemon-reload
    systemctl reset-failed
    
    echo
    green "==== å¸è½½æ“ä½œå·²å®Œæˆ ===="
    if [[ "$deep_clean" != "y" && "$deep_clean" != "Y" ]]; then
        yellow "æç¤ºï¼šé…ç½®æ–‡ä»¶å·²ä¿ç•™ã€‚å¦‚éœ€é‡æ–°å®‰è£…ï¼Œå¯ä»¥ç›´æ¥è¿è¡Œè„šæœ¬ã€‚"
    else
        yellow "æç¤ºï¼šè„šæœ¬è‡ªèº« ($0) å°šæœªåˆ é™¤ï¼Œæ‚¨å¯ä»¥æ‰‹åŠ¨åˆ é™¤å®ƒã€‚"
    fi
    echo
    sleep 2
    return 0
}

# --- 18. è„šæœ¬å…¥å£ä¸åˆå§‹åŒ–  ---

# --- ç³»ç»Ÿå…¼å®¹æ€§æ£€æŸ¥å‡½æ•° ---
check_system_compatibility() {
    # æ£€æŸ¥æ˜¯å¦ä¸ºrootç”¨æˆ·
    if [[ $EUID -ne 0 ]]; then
        red "é”™è¯¯: æ­¤è„šæœ¬å¿…é¡»ä»¥rootç”¨æˆ·èº«ä»½è¿è¡Œ"
        exit 1
    fi
    
    # æ£€æŸ¥ç³»ç»Ÿæ˜¯å¦ä½¿ç”¨systemd
    if ! command -v systemctl &> /dev/null; then
        red "é”™è¯¯: æ­¤è„šæœ¬éœ€è¦systemdæ”¯æŒï¼Œä½†æ‚¨çš„ç³»ç»Ÿä¼¼ä¹æ²¡æœ‰å®‰è£…systemd"
        exit 1
    fi
    
    # æ£€æŸ¥å¿…è¦çš„å‘½ä»¤æ˜¯å¦å¯ç”¨
    local required_commands=("curl" "wget" "jq" "openssl")
    local missing_commands=()
    
    for cmd in "${required_commands[@]}"; do
        if ! command -v "$cmd" &> /dev/null; then
            missing_commands+=("$cmd")
        fi
    done
    
    if [[ ${#missing_commands[@]} -gt 0 ]]; then
        yellow "è­¦å‘Š: ä»¥ä¸‹å¿…è¦å‘½ä»¤åœ¨ç³»ç»Ÿä¸­ä¸å¯ç”¨:"
        for cmd in "${missing_commands[@]}"; do
            echo "  - $cmd"
        done
        yellow "å°†å°è¯•åœ¨åˆå§‹åŒ–è¿‡ç¨‹ä¸­å®‰è£…è¿™äº›ä¾èµ–"
    fi
}

# é¦–æ¬¡è¿è¡Œæ£€æŸ¥å’Œå®‰è£…æ ¸å¿ƒç¨‹åº
initial_check_and_install() {
    # æ·»åŠ ç³»ç»Ÿå…¼å®¹æ€§æ£€æŸ¥
    check_system_compatibility
    
    install_dependencies
    local has_configs=false
    if is_installed; then has_configs=true; fi
    
    # æ£€æŸ¥æ ¹ç›®å½•ä¸‹çš„æ–‡ä»¶
    local kcp_udp_ok=true; if [[ ! -f "$KCPTUN_INSTALL_DIR/kcptun_server" || ! -f "$UDP2RAW_INSTALL_DIR/udp2raw" ]]; then kcp_udp_ok=false; fi
    local hy2_ok=true; if [[ ! -f "$HY2_INSTALL_DIR/hysteria" ]]; then hy2_ok=false; fi
    local xray_ok=true; if [[ ! -f "$XRAY_INSTALL_DIR/xray" ]]; then xray_ok=false; fi
    
    if [[ "$has_configs" == true && ( "$kcp_udp_ok" == false || "$hy2_ok" == false || "$xray_ok" == false ) ]]; then
        clear; yellow "æ£€æµ‹åˆ°å·²å­˜åœ¨çš„é…ç½®æ–‡ä»¶ï¼Œä½†æ ¸å¿ƒç¨‹åºæ–‡ä»¶ä¸å®Œæ•´ã€‚"; read -p "æ˜¯å¦ä¿ç•™é…ç½®å¹¶ä»…é‡æ–°å®‰è£…æ ¸å¿ƒç¨‹åºï¼Ÿ(é»˜è®¤â€œæ˜¯â€) [Y/n]: " choice
        if [[ "$choice" != "n" && "$choice" != "N" ]]; then
            log "æ­£åœ¨é‡æ–°å®‰è£…æ ¸å¿ƒç¨‹åº..."
            [[ "$kcp_udp_ok" == false ]] && download_kcp_udp_binaries
            [[ "$hy2_ok" == false ]] && download_hysteria2_binary
            [[ "$xray_ok" == false ]] && download_xray_binary
            green "æ ¸å¿ƒç¨‹åºé‡è£…å®Œæˆã€‚"; sleep 2
        else
            uninstall_all; exit 0
        fi
    elif [[ "$kcp_udp_ok" == false || "$hy2_ok" == false || "$xray_ok" == false ]]; then
        clear; yellow "é¦–æ¬¡è¿è¡Œæˆ–ç¨‹åºä¸å®Œæ•´ï¼Œéœ€è¦ä¸‹è½½æ ¸å¿ƒç¨‹åºæ–‡ä»¶ã€‚"; log "æ­£åœ¨è‡ªåŠ¨ä¸‹è½½æ‰€æœ‰æ ¸å¿ƒç¨‹åº..."
        [[ "$kcp_udp_ok" == false ]] && (download_kcp_udp_binaries || { red "KCP/UDP ä¸‹è½½å¤±è´¥ï¼Œé€€å‡ºã€‚"; exit 1; })
        [[ "$hy2_ok" == false ]] && (download_hysteria2_binary || { red "Hysteria2 ä¸‹è½½å¤±è´¥ï¼Œé€€å‡ºã€‚"; exit 1; })
        [[ "$xray_ok" == false ]] && (download_xray_binary || { red "Xray-core ä¸‹è½½å¤±è´¥ï¼Œé€€å‡ºã€‚"; exit 1; })
        green "æ ¸å¿ƒç¨‹åºå‡†å¤‡å°±ç»ªã€‚"; sleep 2
    fi
    download_aux_tools; ensure_template_files; sleep 1
}

# ä¸»èœå•çŠ¶æ€æ€»è§ˆ (ä½¿ç”¨ç²—ä½“æ ‡é¢˜)
show_status_summary() {
    local menu_index=21; echo "--- å½“å‰çŠ¶æ€ (è¾“å…¥åºå·å¯ç›´æ¥ç®¡ç†) ---"; if ! is_installed; then yellow "æœªå®‰è£…ä»»ä½•ç»„ä»¶ã€‚"; return; fi
    
    local ss_3_chain_instances=$(get_chain_instances_3)
    if [[ -n "$ss_3_chain_instances" ]]; then
        echo "$(bold "SS+KCP+UDP ä¸²è”å®ä¾‹:")"
        for i in $ss_3_chain_instances; do display_instance_status_line "ss_3_chain_chain" "$i" "$menu_index) "; QUICK_MANAGE_MAP_ID[$menu_index]=$i; QUICK_MANAGE_MAP_TYPE[$menu_index]="ss_3_chain_chain"; menu_index=$((menu_index + 1)); done
    fi
    local hy2_chain_instances=$(get_chain_instances "hy2")
    if [[ -n "$hy2_chain_instances" ]]; then
        echo "$(bold "Hysteria2+UDP ä¸²è”å®ä¾‹:")"
        for i in $hy2_chain_instances; do display_instance_status_line "hy2_chain" "$i" "$menu_index) "; QUICK_MANAGE_MAP_ID[$menu_index]=$i; QUICK_MANAGE_MAP_TYPE[$menu_index]="hy2_chain"; menu_index=$((menu_index + 1)); done
    fi
    local vless_chain_instances=$(get_chain_instances "vless")
    if [[ -n "$vless_chain_instances" ]]; then
        echo "$(bold "VLESS_mKCP+UDP ä¸²è”å®ä¾‹:")"
        for i in $vless_chain_instances; do display_instance_status_line "vless_chain" "$i" "$menu_index) "; QUICK_MANAGE_MAP_ID[$menu_index]=$i; QUICK_MANAGE_MAP_TYPE[$menu_index]="vless_chain"; menu_index=$((menu_index + 1)); done
    fi

    for type in "Hysteria2" "VLESS+Reality" "VLESS+mKCP" "Shadowsocks" "UDP2RAW" "KCPTUN"; do
        local type_lowercase=""
        case "$type" in
            "Hysteria2") type_lowercase="hysteria2";;
            "VLESS+Reality") type_lowercase="xray_reality";;
            "VLESS+mKCP") type_lowercase="xray_mkcp";;
            "Shadowsocks") type_lowercase="xray_ss";;
            "UDP2RAW") type_lowercase="udp2raw";;
            "KCPTUN") type_lowercase="kcptun";;
        esac
        
        local standalone_instances=($(get_standalone_instances "$type_lowercase"))

        if [[ ${#standalone_instances[@]} -gt 0 ]]; then
            echo "$(bold "${type} (ç‹¬ç«‹) å®ä¾‹:")"
            for i in "${standalone_instances[@]}"; do
                display_instance_status_line "$type_lowercase" "$i" "$menu_index) "
                QUICK_MANAGE_MAP_ID[$menu_index]=$i; QUICK_MANAGE_MAP_TYPE[$menu_index]="$type_lowercase"; menu_index=$((menu_index + 1))
            done
        fi
    done
}

# åˆ†å‘ç®¡ç†èœå•
dispatch_management_menu() {
    local type=$1
    local id=$2
    case "$type" in
        "ss_3_chain_chain") manage_chain_instance_3 "$id" ;;
        "hy2_chain") manage_chain_instance "hy2" "$id" ;;
        "vless_chain") manage_chain_instance "vless" "$id" ;;
        "hysteria2") manage_instance_menu "hysteria2" "$id" "ax-hysteria2@${id}" "$HY2_INSTALL_DIR/hy2_${id}.yaml" ;;
        "xray_reality") manage_instance_menu "xray_reality" "$id" "ax-xray@${id}" "$XRAY_INSTALL_DIR/xray_${id}.json" ;;
        "xray_mkcp") manage_instance_menu "xray_mkcp" "$id" "ax-xray@${id}" "$XRAY_INSTALL_DIR/xray_${id}.json" ;;
        "xray_ss") manage_instance_menu "xray_ss" "$id" "ax-xray@${id}" "$XRAY_INSTALL_DIR/xray_${id}.json" ;;
        "udp2raw") manage_instance_menu "udp2raw" "$id" "ax-udp2raw@${id}" "$UDP2RAW_INSTALL_DIR/udp2raw_${id}.conf" ;;
        "kcptun") manage_instance_menu "kcptun" "$id" "ax-kcptun@${id}" "$KCPTUN_INSTALL_DIR/kcptun_${id}.json" ;;
    esac
}

# ä¸»èœå• 
main_menu(){
    declare -A QUICK_MANAGE_MAP_ID; declare -A QUICK_MANAGE_MAP_TYPE
    while true; do
        QUICK_MANAGE_MAP_ID=(); QUICK_MANAGE_MAP_TYPE=()
        trap '' SIGINT
        clear; echo "=================================="; echo "  å¤šåˆä¸€éš§é“ç®¡ç†è„šæœ¬ V$SCRIPT_VERSION"; echo "=================================="
        cyan "--- ä¸²è”ç®¡ç† ---"
        echo " 1) Hysteria2+UDP2RAW ä¸²è”"
        echo " 2) VLESS_mKCP+UDP2RAW ä¸²è”"
        echo " 3) Shadowsocks+KCP+UDP ä¸²è”"
        cyan "--- ç‹¬ç«‹å®ä¾‹ç®¡ç† ---"
        echo " 4) Hysteria2"
        echo " 5) VLESS+Reality"
        echo " 6) VLESS+mKCP"
        echo " 7) Shadowsocks"
        cyan "--- åŠ é€Ÿç®¡ç† ---"
        echo " 8) UDP2RAW"
        echo " 9) KCPTUN"
        echo "----------------------------------"
        cyan "--- å…¨å±€æ“ä½œ ---"
        echo " 10) æŸ¥çœ‹å…¨éƒ¨é…ç½®"
        echo " 11) é‡å¯å…¨éƒ¨æœåŠ¡"
        echo " 12) æ£€æŸ¥æ›´æ–°ç¨‹åº" 
        cyan "--- å·¥å…·ç®¡ç† ---"
        echo " 13) ä¸€é”®ä¼˜åŒ–ç³»ç»Ÿ"
        echo " 14) ä¸€é”®å¼€å¯warp-Socks5"
        echo " 15) ACME è¯ä¹¦ç®¡ç†"
        echo "----------------------------------"   
        echo " 99) å¸è½½"
        echo " 0) é€€å‡º"
        
        # --- å…¨å±€ TLS çŠ¶æ€ (ä½äº 0 å’Œ "å½“å‰çŠ¶æ€" ä¹‹é—´) ---
        echo "----------------------------------"
        show_global_tls_status
        # --- ACME çŠ¶æ€ç»“æŸ ---
        
        echo "----------------------------------"
        show_status_summary
        local num_items=${#QUICK_MANAGE_MAP_ID[@]}; local max_index=$((20 + num_items))
        echo "----------------------------------"
        # [MODIFIED] æ›´æ”¹æç¤ºç¬¦èŒƒå›´
        local prompt="è¯·é€‰æ‹© [0-15, 99"; if [[ $num_items -gt 0 ]]; then prompt+=", 21-${max_index}]"; else prompt+="]"; fi
        read -p "$promptï¼š " choice
        
        if [[ -n "${QUICK_MANAGE_MAP_ID[$choice]}" ]]; then
            local real_id="${QUICK_MANAGE_MAP_ID[$choice]}"; local type="${QUICK_MANAGE_MAP_TYPE[$choice]}"
            dispatch_management_menu "$type" "$real_id"
            continue
        fi
        
        case $choice in
            1) chain_manager_menu "hy2" ;;
            2) chain_manager_menu "vless" ;;
            3) chain_manager_menu_3 ;;
            4) main_manager_loop "hysteria2" ;; 
            5) main_manager_loop "xray_reality" ;;
            6) main_manager_loop "xray_mkcp" ;; 
            7) main_manager_loop "xray_ss" ;;
            8) main_manager_loop "udp2raw" ;;
            9) main_manager_loop "kcptun" ;;
            10) view_all_configs; read -p $'\næŒ‰ä»»æ„é”®è¿”å›...' -n1 -s;;
            11) restart_all_services ;;
            12) check_for_updates; read -p "æŒ‰ä»»æ„é”®ç»§ç»­..." -n1 -s ;;
            13) clear; install_sys_opt; read -p $'\næŒ‰ä»»æ„é”®è¿”å›...' -n1 -s ;;
            14) clear; install_warp_yg; read -p $'\næŒ‰ä»»æ„é”®è¿”å›...' -n1 -s ;;
            15) acme_manager_menu ;;
            99) uninstall_all; if [[ $? -eq 0 ]]; then exit 0; fi ;;
            0) trap - SIGINT; exit 0 ;; 
            *) red "æ— æ•ˆé€‰æ‹©!"; sleep 1 ;;
        esac
    done
}

# --- 19. è„šæœ¬æ‰§è¡Œå…¥å£ ---
# æ•è· Ctrl+C ä¿¡å·ï¼Œä»¥ä¾¿åœ¨è„šæœ¬ä¸»ä½“æ‰§è¡ŒæœŸé—´ä¼˜é›…é€€å‡º
trap 'echo -e "\n\n${yellow}æ“ä½œè¢«ä¸­æ–­ï¼Œé€€å‡ºè„šæœ¬ã€‚${reset}"; trap - SIGINT; exit 1' SIGINT
# åˆå§‹åŒ–æ£€æŸ¥å’Œå®‰è£…
initial_check_and_install
# æ˜¾ç¤ºä¸»èœå•
main_menu
